"use strict";const e=require("../common/vendor.js"),r="https://www.aimh8.com/agent/";function t(){const r=e.index.getStorageSync("user_info");if(!r)return console.log("未找到用户信息"),"";try{return JSON.parse(r).uni_token||""}catch(t){return console.error("解析用户信息失败:",t),""}}function o(e){if(!e)return"0";const r=function(e){if(!e)return 0;const r=((e=(e=e.replace(/<[^>]*>/g,"")).replace(/\s+/g," ").trim()).match(/[\u4e00-\u9fa5\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\uAC00-\uD7A3\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uD7B0-\uD7FF]/g)||[]).length,t=e.replace(/[\u4e00-\u9fa5\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\uAC00-\uD7A3\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uD7B0-\uD7FF]/g," ").split(" ").filter((e=>e.length>0));let o=0;for(let n of t)if(/^[a-zA-Z]+$/.test(n)||/^[0-9]+$/.test(n))n.length<=25?o+=1:o+=Math.ceil(n.length/25);else{let e=0;const r=n.match(/[a-zA-Z0-9]+/g)||[];for(let t of r)t.length<=25?e+=1:e+=Math.ceil(t.length/25);e+=(n.match(/[^\w\s]/g)||[]).length,o+=e}return r+o}(e);return Math.ceil(Math.max(1,Math.round(r/200*10)/10)).toFixed(0)}exports.SERVER_URL=r,exports.estimateDuration=o,exports.estimatePoints=function(e,r){if(!e)return"0";var t=r||10;const n=parseFloat(o(e));return Math.round(n*t)},exports.estimatePoints_income=function(e,r){if(!e)return"0";var t=r||10;t=.9*(t-10);const n=parseFloat(o(e));return Math.round(n*t)},exports.getGenerateProgress=function(o){const n=t();n?e.index.request({url:r+"get_generate_progress2",method:"POST",data:{uni_token:n},success:e=>{if(e.data.code>0){const r=e.data.value,t=e.data.task_id;"function"==typeof o&&o({progress:r,taskId:t,isComplete:r>=100})}else console.error("获取进度失败:",e.data.msg),"function"==typeof o&&o({error:e.data.msg||"获取进度失败"})},fail:e=>{console.error("获取进度失败:",e),"function"==typeof o&&o({error:"网络请求失败"})}}):console.error("获取进度失败: 未获取到用户token")},exports.getLatestUserInfo=function(){return new Promise(((o,n)=>{const s=t();s?e.index.request({url:r+"get_user_info",method:"POST",data:{uni_token:s},success:r=>{if(r.data.code>=0&&r.data.userInfo)try{e.index.setStorageSync("user_info",JSON.stringify(r.data.userInfo)),o(r.data.userInfo)}catch(t){console.error("保存用户信息失败:",t),n(t)}else{const e=new Error(r.data.msg||"获取用户信息失败");console.error("获取用户信息失败:",e),n(e)}},fail:e=>{console.error("更新用户信息网络错误:",e),n(e)}}):n(new Error("未找到用户token"))}))},exports.getMiniProgramInfo=function(t){return new Promise(((o,n)=>{t?e.index.request({url:r+"get_wechat_mini_program_info_by_appid",method:"POST",data:{appid:t},success:r=>{if(r.data.code>=0)try{e.index.setStorageSync("mini_program_title",r.data.title),o(r.data)}catch(t){console.error("保存用户信息失败:",t),n(t)}else{const e=new Error(r.data.msg||"获取用户信息失败");console.error("获取用户信息失败:",e),n(e)}},fail:e=>{console.error("更新用户信息网络错误:",e),n(e)}}):n(new Error("未找到微信的appid"))}))},exports.getUserBalance=function(){const r=e.index.getStorageSync("user_info");if(!r)return console.log("未找到用户信息"),"";try{return JSON.parse(r).coins||0}catch(t){return console.error("解析用户信息失败:",t),""}},exports.getUserID=function(){const r=e.index.getStorageSync("user_info");if(!r)return console.log("未找到用户信息"),"";try{return JSON.parse(r).id||0}catch(t){return console.error("解析用户信息失败:",t),""}},exports.getUserInfo=function(){const r=e.index.getStorageSync("user_info");if(!r)return console.log("未找到用户信息"),"";try{return JSON.parse(r)||null}catch(t){return console.error("解析用户信息失败:",t),""}},exports.getUserUniToken=t,exports.hasVideoPermission=function(){const r=e.index.getStorageSync("user_info");if(!r)return console.log("未找到用户信息"),!1;try{const e=JSON.parse(r);if((e.user_type||0)>1)return!0;if((e.coins||0)>0)return!0}catch(t){return console.error("解析用户信息失败:",t),!1}return!1},exports.initGlobalConfig=function(){e.index.setStorageSync("serverUrl",r),console.log("全局配置初始化完成")};
