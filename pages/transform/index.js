"use strict";const e=require("../../common/vendor.js"),a="https://www.aimh8.com/agent/api",t={__name:"index",setup(t){const o=e.index.getStorageSync("phoneNum"),n=e.index.getStorageSync("user_id"),s=e.ref(""),i=e.ref(""),r=e.ref(""),l=e.ref(null),c=e.ref(!1),d=e.ref(!1),u=e.ref(""),h=e.ref("");e.onMounted((async()=>{const e=getApp().globalData.currentOptions;e&&(s.value=e.videoId,i.value=e.thumbnail),await w(),await _()}));const m=()=>{e.index.showActionSheet({itemList:["竖屏","横屏"],success:function(e){console.log("选择的分辨率:",e.tapIndex),u.value=0===e.tapIndex?"竖屏":"横屏"}})},g=()=>{e.index.showActionSheet({itemList:["风格1","风格2","风格3"],success:function(e){console.log("选择的模板:",e.tapIndex),h.value=`风格${e.tapIndex+1}`}})},w=async()=>{try{const a=await e.index.request({url:"pre_url",method:"POST",data:{api_name:"get_pictrue_promts",user_id:n,username:o}});if(a.data.code>0){const e=a.data.list;return console.log("获取到的提示词列表:",e),e}throw new Error(a.data.msg)}catch(a){e.index.showToast({title:"获取提示词失败，请检查网络或重试",icon:"none"}),console.error("获取提示词失败:",a)}},v=async()=>{if(s.value){c.value=!0;try{const t=await e.index.request({url:a,method:"POST",data:{api_name:"request_2pics",user_id:n,username:o,muban_id:s.value}});if(!(t.data.code>0))throw new Error(t.data.msg);await p()}catch(t){e.index.showToast({title:"生成失败，请检查网络或重试",icon:"none"}),console.error("生成失败:",t)}finally{c.value=!1}}else e.index.showToast({title:"模板ID无效",icon:"none"})},p=async()=>{try{for(;;){const t=await e.index.request({url:a,method:"POST",data:{api_name:"gene_progress",user_id:n,username:o}});if(!(t.data.code>0))throw new Error(t.data.msg);{const a=t.data.value;if(a>=100){await x();break}e.index.showLoading({title:`生成中...${a}%`,mask:!0}),await new Promise((e=>setTimeout(e,1e3)))}}}catch(t){e.index.showToast({title:"进度获取失败，请检查网络或重试",icon:"none"}),console.error("进度获取失败:",t)}finally{e.index.hideLoading()}},x=async()=>{try{const t=await e.index.request({url:a,method:"POST",data:{api_name:"get_2pics",user_id:n,username:o}});if(!(t.data.code>0&&t.data.list))throw new Error(t.data.msg);r.value=t.data.list}catch(t){e.index.showToast({title:"图片获取失败，请检查网络或重试",icon:"none"}),console.error("图片获取失败:",t)}},_=async(a=1,t=10)=>{try{const s=await e.index.request({url:"pre_url",method:"POST",data:{api_name:"get_allpics",user_id:n,username:o,page:a,page_size:t}});if(s.data.code>0){const e=s.data.list,a=s.data.total_pages;return console.log("获取到的历史合成照片列表:",e),console.log("总页数:",a),{historyImages:e,totalPages:a}}throw new Error(s.data.msg)}catch(s){e.index.showToast({title:"获取历史照片失败，请检查网络或重试",icon:"none"}),console.error("获取历史照片失败:",s)}},f=async()=>{if(null!==l.value){d.value=!0;try{e.index.showLoading({title:"处理中...",mask:!0}),await new Promise((e=>setTimeout(e,6e3))),e.index.navigateBack();const a=getCurrentPages(),t=a[a.length-2];t&&t.$vm.fetchVideos&&t.$vm.fetchVideos()}catch(a){e.index.showToast({title:"处理失败，请检查网络或重试",icon:"none"}),console.error("处理失败:",a)}finally{d.value=!1,e.index.hideLoading()}}};return(a,t)=>e.e({a:i.value,b:e.t(u.value||"选择分辨率"),c:e.o(m),d:e.t(h.value||"选择新模板风格"),e:e.o(g),f:e.t(c.value?"生成中...":"开始变装"),g:e.o(v),h:c.value,i:r.value.length>0},r.value.length>0?{j:e.f(r.value,((a,t,o)=>({a:a,b:t,c:l.value===t?1:"",d:e.o((e=>(e=>{l.value=e})(t)),t)})))}:{},{k:null!==l.value},null!==l.value?{l:e.t(d.value?"处理中...":"下一步"),m:e.o(f),n:d.value}:{})}},o=e._export_sfc(t,[["__scopeId","data-v-c71cec37"]]);wx.createPage(o);
