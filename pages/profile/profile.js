"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/config.js"),o=require("../../common/assets.js"),n={data:()=>({isLoggedIn:!1,userInfo:{id:"",nickname:"",avatar:"/static/images/default-avatar.png",balance:0,avatarCount:0,videoCount:0},newNickname:"",oldPassword:"",newPassword:"",confirmNewPassword:"",nicknameError:"",passwordError:"",contactList:[],showCoinModal:!1,typeLabels:{0:{text:"普通用户"},1:{text:"高级用户"},3:{text:"运营商"},4:{text:"训练员"},9:{text:"管理员"}}}),methods:{checkLoginStatus(){const o=e.index.getStorageSync("logged_in");this.isLoggedIn=!!o,this.isLoggedIn&&t.getLatestUserInfo().then((e=>{console.log(e),e&&(this.mapUserData(e),console.log(this.userInfo),this.getAvatarCount(),this.getDocumentCount())})).catch((e=>{console.error("获取最新用户信息失败:",e);const o=t.getUserInfo();o&&(this.mapUserData(o),this.getAvatarCount(),this.getDocumentCount())}))},toLogin(){e.index.navigateTo({url:"/pages/login/login"})},navigateTo(t){e.index.navigateTo({url:t})},editAvatar(){e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{const o=t.tempFilePaths[0];e.index.getFileInfo({filePath:o,success:t=>{t.size/1048576>2?e.index.showToast({title:"图片大小不能超过2MB",icon:"none"}):this.uploadAvatar(o)},fail:t=>{e.index.showToast({title:"获取文件信息失败",icon:"none"})}})}})},async uploadAvatar(o){e.index.showLoading({title:"上传中..."});try{t.getUserUniToken();const n=await e.index.request({url:t.SERVER_URL+"get_oss_token_policy2",method:"POST",data:{},header:{"Content-Type":"application/json"}});if(n.data.code<0)return e.index.hideLoading(),void e.index.showToast({title:"获取上传凭证失败",icon:"none"});const s="data/user/avatar/",a=t.getUserID()+"_"+n.data.ossdata.x_oss_date+".jpg",i={key:s+a,policy:n.data.ossdata.policy,"x-oss-signature-version":n.data.ossdata.x_oss_signature_version,"x-oss-credential":n.data.ossdata.x_oss_credential,"x-oss-date":n.data.ossdata.x_oss_date,"x-oss-signature":n.data.ossdata.signature,"x-oss-security-token":n.data.ossdata.security_token,success_action_status:"200"};console.log(i),e.index.uploadFile({url:"https://foco-aimh8.oss-cn-hangzhou.aliyuncs.com",filePath:o,name:"file",formData:i,success:t=>{console.log(t),200===t.statusCode?this.updateAvatarPath(a):(e.index.hideLoading(),e.index.showToast({title:"上传失败: "+t.statusCode,icon:"none"}))},fail:t=>{e.index.hideLoading(),e.index.showToast({title:"上传失败: "+t.errMsg,icon:"none"})}})}catch(n){e.index.hideLoading(),e.index.showToast({title:"上传失败: "+n.message,icon:"none"})}},updateAvatarPath(o){const n=t.getUserUniToken();e.index.request({url:t.SERVER_URL+"update_avatar",method:"POST",data:{uni_token:n,head_icon_url:o},header:{"Content-Type":"application/json"},success:n=>{if(e.index.hideLoading(),n.data.code>0){const n=`https://oss.aimh8.com/data/user/avatar/${o}`;this.userInfo.avatar=n;const s=t.getUserInfo();s&&(s.avatar=n,e.index.setStorageSync("user_info",JSON.stringify(s))),e.index.showToast({title:"头像更新成功",icon:"success"})}else e.index.showToast({title:n.data.msg||"头像更新失败",icon:"none"})},fail:t=>{e.index.hideLoading(),e.index.showToast({title:"网络错误: "+t.errMsg,icon:"none"})}})},editNickname(){e.index.showModal({title:"修改昵称",editable:!0,placeholderText:"请输入新昵称",content:this.userInfo.nickname||"",success:t=>{if(t.confirm&&t.content){const o=t.content.trim();if(!o)return void e.index.showToast({title:"昵称不能为空",icon:"none"});if(o.length>10)return void e.index.showToast({title:"昵称不能超过10个字符",icon:"none"});this.updateNickname(o)}}})},updateNickname(o){e.index.showLoading({title:"更新中..."}),e.index.request({url:t.SERVER_URL+"update_nicename",method:"POST",data:{uni_token:t.getUserUniToken(),nicename:o},header:{"content-type":"application/json"},success:n=>{if(n.data.code>0){this.userInfo.nickname=o;const n=t.getUserInfo();n&&(n.name=o,e.index.setStorageSync("userInfo",JSON.stringify(n))),e.index.showToast({title:"昵称更新成功",icon:"success"})}else e.index.showToast({title:n.data.msg||"昵称更新失败",icon:"none"})},fail:()=>{e.index.showToast({title:"网络错误，请稍后重试",icon:"none"})},complete:()=>{e.index.hideLoading()}})},changePassword(){this.showPasswordInputModal(1)},showPasswordInputModal(t,o={}){1===t?e.index.showModal({title:"修改密码",editable:!0,content:"",placeholderText:"请输入原密码",success:t=>{if(t.confirm&&t.content){const o=t.content;if(!o)return void e.index.showToast({title:"原密码不能为空",icon:"none"});this.showPasswordInputModal(2,{oldPassword:o})}}}):2===t?e.index.showModal({title:"修改密码",editable:!0,content:"",placeholderText:"请输入新密码(6-12位)",success:t=>{if(t.confirm&&t.content){const n=t.content;if(!n)return void e.index.showToast({title:"新密码不能为空",icon:"none"});if(n.length<6)return void e.index.showToast({title:"新密码不能少于6位",icon:"none"});if(n.length>12)return void e.index.showToast({title:"新密码不能超过12位",icon:"none"});this.showPasswordInputModal(3,{oldPassword:o.oldPassword,newPassword:n})}}}):3===t&&e.index.showModal({title:"修改密码",editable:!0,content:"",placeholderText:"请再次输入新密码",success:t=>{if(t.confirm&&t.content){if(t.content!==o.newPassword)return void e.index.showToast({title:"两次输入的密码不一致",icon:"none"});this.submitPasswordChange(o.oldPassword,o.newPassword)}}})},submitPasswordChange(o,n){e.index.showLoading({title:"更新中..."}),e.index.request({url:t.SERVER_URL+"reset_password",method:"POST",data:{uni_token:t.getUserUniToken(),old_password:o,new_password:n},header:{"content-type":"application/json"},success:t=>{t.data.code>0?e.index.showToast({title:"密码修改成功",icon:"success"}):e.index.showToast({title:t.data.msg||"密码修改失败",icon:"none"})},fail:()=>{e.index.showToast({title:"网络错误，请稍后重试",icon:"none"})},complete:()=>{e.index.hideLoading()}})},logout(){e.index.showModal({title:"提示",content:"确定要退出登录吗？",success:t=>{t.confirm&&(e.index.removeStorageSync("logged_in"),e.index.removeStorageSync("user_info"),e.index.reLaunch({url:"/pages/login/login"}))}})},mapUserData(e){var t;this.userInfo={id:e.id||"",nickname:e.name||"未设置昵称",username:e.username||"",avatar:e.avatar||"/static/images/default-avatar.png",balance:e.coins||0,avatarCount:e.avatar_count||0,videoCount:e.video_count||0,level:e.level||"1",registerTime:e.register_time||"",userType:e.user_type||0,userTypeText:(null==(t=this.typeLabels[e.user_type])?void 0:t.text)||"普通用户"}},showCoinsInfo(){e.index.showLoading({title:"加载中..."}),e.index.request({url:t.SERVER_URL+"/get_account_info",method:"POST",data:{uni_token:t.getUserUniToken()},success:t=>{t.data.code>0&&t.data.accountInfo?(this.fillAccountInfo(t.data.accountInfo),this.showContactsModal()):e.index.showModal({title:"提示",content:"无法获取充值联系人信息，请稍后再试",showCancel:!1})},fail:t=>{console.error("获取账户信息出错：",t),e.index.showModal({title:"提示",content:"网络错误，请稍后再试",showCancel:!1})},complete:()=>{e.index.hideLoading()}})},showContactsModal(){0!==this.contactList.length?this.showCoinModal=!0:e.index.showModal({title:"购买Coins",content:"暂无充值联系人信息，请联系管理员",showCancel:!1})},closeCoinModal(){this.showCoinModal=!1},fillAccountInfo(e){this.contactList=[],e.upid&&(e.upid_name||e.upid_username)&&this.contactList.push({name:e.upid_name||"上级用户",username:e.upid_username||"",bgClass:"bg-primary",icon:"user"}),e.partner_id&&(e.partner_name||e.partner_username)&&this.contactList.push({name:e.partner_name||"合作伙伴",username:e.partner_username||"",bgClass:"bg-success",icon:"user"})},getAvatarCount(){e.index.request({url:t.SERVER_URL+"get_user_avatars",method:"POST",data:{uni_token:t.getUserUniToken(),page:1,page_size:1},header:{"Content-Type":"application/json"},success:e=>{const t=e.data;t.code>0&&(this.userInfo.avatarCount=t.total||0)},fail:e=>{console.error("获取数字人数量失败:",e)}})},getDocumentCount(){e.index.request({url:t.SERVER_URL+"get_user_documents",method:"POST",data:{uni_token:t.getUserUniToken(),page:1,page_size:1},header:{"Content-Type":"application/json"},success:e=>{const t=e.data;t.code>0&&(this.userInfo.videoCount=t.total||0)},fail:e=>{console.error("获取文案总数失败:",e)}})}},onLoad(){this.checkLoginStatus()},onShow(){this.checkLoginStatus()}};const s=e._export_sfc(n,[["render",function(t,n,s,a,i,d){return e.e({a:!i.isLoggedIn},i.isLoggedIn?{d:i.userInfo.avatar||"/static/images/default-avatar.png",e:e.o(((...e)=>d.editAvatar&&d.editAvatar(...e))),f:e.t(i.userInfo.nickname||"未设置昵称"),g:e.o(((...e)=>d.editNickname&&d.editNickname(...e))),h:e.t(i.userInfo.id),i:e.t(i.userInfo.username),j:e.t(i.userInfo.userTypeText),k:e.t(i.userInfo.balance),l:e.o(((...e)=>d.showCoinsInfo&&d.showCoinsInfo(...e))),m:e.t(i.userInfo.avatarCount||0),n:e.t(i.userInfo.videoCount||0),o:e.o((e=>d.navigateTo("/pages/my_documents/my_documents"))),p:e.o(((...e)=>d.showCoinsInfo&&d.showCoinsInfo(...e))),q:e.o(((...e)=>d.changePassword&&d.changePassword(...e))),r:e.o((e=>d.navigateTo("/pages/about/about"))),s:e.o((e=>d.navigateTo("/pages/support/index"))),t:e.o(((...e)=>d.logout&&d.logout(...e)))}:{b:o._imports_0$4,c:e.o(((...e)=>d.toLogin&&d.toLogin(...e)))},{v:i.showCoinModal},i.showCoinModal?e.e({w:e.o(((...e)=>d.closeCoinModal&&d.closeCoinModal(...e))),x:e.f(i.contactList,((t,o,n)=>({a:e.n(t.bgClass),b:e.t(t.name),c:e.t(t.username),d:o,e:e.n(o>0?"mt-card":"")}))),y:0===i.contactList.length},(i.contactList.length,{}),{z:e.o(((...e)=>d.closeCoinModal&&d.closeCoinModal(...e)))}):{})}]]);wx.createPage(s);
