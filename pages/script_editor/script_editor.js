"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/config.js"),i={data:()=>({avatarId:"",avatar:{id:"",name:"加载中...",image:"/static/images/placeholder.jpg",owner:"加载中...",price:10,strictReview:!1,preview_video:"",nicename:"",isdefault:0,up_user_name:"",creator_id:0},document:{id:0,status:-1,oss_path:"",generate_video_id:-1},scriptContent:"",estimatedDuration:0,calculatedCost:0,userBalance:0,enableSubtitle:!0,selectedMusicIndex:0,selectedBackgroundIndex:0,showTemplatePopup:!1,scriptTemplates:[{id:1,title:"产品介绍模板",content:"大家好，我是[姓名]。今天我要为大家介绍一款革命性的产品—[产品名称]。这款产品有以下几个突出特点：首先，[特点一]。其次，[特点二]。最后，[特点三]。如果你对这款产品感兴趣，可以通过以下渠道了解更多信息..."},{id:2,title:"教育课程模板",content:"欢迎来到[课程名称]。我是你的讲师[姓名]。在今天的课程中，我们将学习关于[主题]的知识。我们将分为三个部分：第一，[内容一]；第二，[内容二]；第三，[内容三]。让我们开始今天的学习吧！"},{id:3,title:"企业宣传模板",content:"尊敬的各位来宾，感谢您参加[公司名称]的宣传活动。我们公司成立于[年份]，专注于[业务领域]。经过多年发展，我们已成为行业领先的[成就描述]。我们的使命是[使命描述]，我们的愿景是[愿景描述]。期待与您合作共赢！"}],isLoadingAvatar:!0,currentUserId:0,generateProgress:0,actionMaps:{0:"立即合成",1:"提交审核",2:"待审核",3:"已被拒绝，重新申请",4:"审核通过，去合成",5:"合成中...",6:"去播放视频"},progressTimer:null,has_permission:!1}),onLoad(e){console.log("onLoad"),e.avatar_id&&(this.avatarId=e.avatar_id,this.fetchAvatarInfo()),console.log(e),t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID(),this.has_permission=t.hasVideoPermission())})).catch((e=>{console.error("获取最新用户信息失败:",e)})),e.document_id&&this.getDocumentInfo(e.document_id)},onUnload(){this.progressTimer&&(clearInterval(this.progressTimer),this.progressTimer=null)},methods:{getActionStatus(e){return this.document.status<=0?e.strictReview?1:0:1==this.document.status?this.document.generate_video_id<0?2:4:2==this.document.status?e.strictReview?3:0:3==this.document.status?5:4==this.document.status?6:void 0},getEditDisabled(e){switch(this.getActionStatus(e)){case 2:case 4:case 5:return!0}return!1},getActionDisabled(e){switch(this.getActionStatus(e)){case 2:case 5:return!0}return!1},getActionName(e){let t=this.getActionStatus(e);return 5==t?`合成中...${this.generateProgress}%`:this.actionMaps[t]},fetchAvatarInfo(){console.log("fetchAvatarInfo"),this.isLoadingAvatar=!0;const i=t.getUserUniToken();e.index.showLoading({title:"加载中..."}),e.index.request({url:t.SERVER_URL+"get_avatar_info",method:"POST",data:{uni_token:i,avatar_id:this.avatarId},success:t=>{if(t.data.code>0&&t.data.avatar){const e=t.data.avatar;this.avatar={id:this.avatarId,name:e.title||"未命名数字人",image:e.preview_image||"/static/images/placeholder.jpg",owner:1==e.isdefault?"官方":e.nicename||"未知用户",price:e.price_min&&e.price_min>0?e.price_min:10,strictReview:1===e.strict_review,preview_video:e.preview_video||"",nicename:e.nicename||"",isdefault:e.isdefault||0,up_user_name:e.up_user_name||"",creator_id:e.creator_id||0},1==e.isdefault&&(this.avatar.strictReview=!1)}else e.index.showToast({title:t.data.msg||"获取数字人信息失败",icon:"none"})},fail:t=>{e.index.showToast({title:"获取数字人信息失败，请检查网络连接",icon:"none"}),console.error("获取数字人信息失败:",t)},complete:()=>{this.isLoadingAvatar=!1,e.index.hideLoading()}})},getDocumentInfo(i){e.index.showLoading({title:"加载文件中..."});const a=t.getUserUniToken();e.index.request({url:t.SERVER_URL+"get_document_info",method:"POST",data:{uni_token:a,document_id:i},success:t=>{if(t.data.code>0&&t.data.document_info){console.log(t.data);const a=t.data.document_info;this.document.id=i,this.document.status=a.status,this.document.oss_path=a.oss_path,this.document.generate_video_id=a.generate_video_id,a.oss_path?e.index.request({url:a.oss_path,method:"GET",success:t=>{t.data?(this.scriptContent=t.data,this.calculateDuration()):e.index.showToast({title:"文件内容为空",icon:"none"})},fail:t=>{e.index.showToast({title:"加载文件内容失败",icon:"none"}),console.error("加载文件内容失败:",t)}}):(this.scriptContent=a.content||"",this.calculateDuration())}else this.document.id=0,e.index.showToast({title:t.data.msg||"获取文档信息失败",icon:"none"})},fail:t=>{e.index.showToast({title:"获取文档信息失败",icon:"none"}),console.error("获取文档信息失败:",t)},complete:()=>{e.index.hideLoading()}})},getUserBalance(){this.userBalance=t.getUserBalance()},calculateDuration(){const e=parseFloat(t.estimateDuration(this.scriptContent));this.estimatedDuration=e,this.calculatedCost=t.estimatePoints(this.scriptContent,this.avatar.price)},useTemplate(){this.showTemplatePopup=!0},applyTemplate(e){this.scriptContent=e.content,this.showTemplatePopup=!1,this.calculateDuration()},clearContent(){e.index.showModal({title:"提示",content:"确定要清空当前内容吗？",success:e=>{e.confirm&&(this.scriptContent="",this.calculateDuration())}})},saveAsDraft(){if(!this.scriptContent.trim())return void e.index.showToast({title:"内容不能为空",icon:"none"});const i=t.getUserUniToken();e.index.showLoading({title:"保存中..."}),e.index.request({url:t.SERVER_URL+"update_document",method:"POST",data:{uni_token:i,avatar_id:this.avatarId,document_id:this.document.id,text:this.scriptContent},success:t=>{console.log(t),t.data.code>0?(this.document.status=0,this.document.id=t.data.document_id,e.index.showToast({title:"保存成功",icon:"success"})):e.index.showToast({title:t.data.msg||"保存失败",icon:"none"})},fail:t=>{e.index.showToast({title:"保存失败，请检查网络连接",icon:"none"}),console.error("保存草稿失败:",t)},complete:()=>{e.index.hideLoading()}})},getVideoUrl(e,t){let i;return i=e.endsWith("/")?e+t:e+"/"+t,i},previewDigitalHuman(){if(!this.avatar.preview_video)return void e.index.showToast({title:"没有可预览的视频",icon:"none"});if(!this.has_permission)return;let t=this.avatar.preview_video;const i=this.getVideoUrl(t,"example.mp4");e.index.navigateTo({url:`/pages/preview/preview?video=${encodeURIComponent(i)}&mainVideo=${encodeURIComponent(this.getVideoUrl(t,"main.mp4"))}&title=${encodeURIComponent(this.avatar.name)}`})},submitScript(i){if(!this.scriptContent.trim())return void e.index.showToast({title:"请先输入文案内容",icon:"none"});if(this.scriptContent.length<6)return void e.index.showToast({title:"文案内容不能少于6个字",icon:"none"});if(this.scriptContent.length>1800)return void e.index.showToast({title:"文案内容不能超过1800个字",icon:"none"});if(this.userBalance<this.calculatedCost)return void e.index.showModal({title:"积分不足",content:"您的积分不足以生成视频，请先充值",confirmText:"去充值",success:t=>{t.confirm&&e.index.navigateTo({url:"/pages/profile/profile"})}});const a=t.getUserUniToken();let s=this.getActionStatus(i);switch(e.index.showLoading({title:1===s?"提交审核中...":"合成处理中..."}),s){case 0:e.index.request({url:t.SERVER_URL+"synthesize_video_strict",method:"POST",data:{uni_token:a,avatar_id:this.avatarId,text:this.scriptContent,document_id:this.document.id},success:i=>{i.data.code>0?(t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID())})).catch((e=>{console.error("获取最新用户信息失败:",e)})),this.document.id=i.data.task_id,this.document.generate_video_id=-1,this.document.status=3,e.index.showToast({title:"提交成功，开始合成",icon:"success",duration:2e3}),this.getGenerateProgress()):e.index.showToast({title:i.data.msg||"提交失败",icon:"none"})},fail:t=>{e.index.showToast({title:"提交失败，请检查网络连接",icon:"none"}),console.error("提交文案失败:",t)},complete:()=>{e.index.hideLoading()}});break;case 1:case 3:e.index.request({url:t.SERVER_URL+"submit_script_for_approval",method:"POST",data:{uni_token:a,avatar_id:this.avatarId,text:this.scriptContent,document_id:this.document.id},success:t=>{t.data.code>0?(this.document.id=t.data.task_id,this.document.status=1,this.document.generate_video_id=-1,e.index.showModal({title:"提交成功",content:"您的文案已提交审核，等待数字人所有者审核后才能去合成视频",showCancel:!1})):e.index.showToast({title:t.data.msg||"提交失败",icon:"none"})},fail:t=>{e.index.showToast({title:"提交失败，请检查网络连接",icon:"none"}),console.error("提交文案失败:",t)},complete:()=>{e.index.hideLoading()}});break;case 2:case 5:break;case 4:e.index.request({url:t.SERVER_URL+"synthesize_video_for_approved",method:"POST",data:{uni_token:a,document_id:this.document.id},success:i=>{i.data.code>0?(t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID())})).catch((e=>{console.error("获取最新用户信息失败:",e)})),this.document.id=i.data.task_id,this.document.generate_video_id=-1,this.document.status=3,e.index.showToast({title:"开始合成视频",icon:"success"}),this.getGenerateProgress()):e.index.showToast({title:i.data.msg||"合成请求失败",icon:"none"})},fail:t=>{e.index.showToast({title:"合成请求失败，请检查网络连接",icon:"none"}),console.error("合成视频请求失败:",t)},complete:()=>{e.index.hideLoading()}});break;case 6:this.document.generate_video_id>0?this.getVideoInfo(this.document.generate_video_id):(e.index.hideLoading(),e.index.showToast({title:"视频ID不存在",icon:"none"}))}},getGenerateProgress(){const e=()=>{t.getGenerateProgress((e=>{e.error?console.error("获取进度失败:",e.error):e.taskId>0&&(this.generateProgress=e.progress,this.processing_task_id=e.taskId,e.isComplete&&(clearInterval(this.progressTimer),this.progressTimer=null,setTimeout((()=>{this.getDocumentInfo(this.document.id)}),5e3)))}))};e(),this.progressTimer||(this.progressTimer=setInterval(e,5e3))},getVideoInfo(i){if(!i)return;const a=t.getUserUniToken();e.index.showLoading({title:"获取视频信息..."}),e.index.request({url:this.$serverUrl+"get_generate_video",method:"POST",data:{uni_token:a,video_id:i},success:t=>{var i;if(e.index.hideLoading(),t.data.code>0&&t.data.videoData&&t.data.videoData.full_file_path){const a=t.data.videoData.full_file_path,s=t.data.videoData.filename||(null==(i=this.avatar)?void 0:i.title)||"视频预览";e.index.navigateTo({url:`/pages/preview/preview?video=${encodeURIComponent(a)}&title=${encodeURIComponent(s)}&download=true`})}else e.index.showToast({title:"获取视频信息失败，无法播放",icon:"none"})},fail:t=>{e.index.hideLoading(),console.error("获取视频信息出错:",t),e.index.showToast({title:"获取视频信息失败，请稍后再试",icon:"none"})}})}}};const a=e._export_sfc(i,[["render",function(t,i,a,s,o,n){return e.e({a:o.avatar.image,b:o.has_permission},(o.has_permission,{}),{c:e.o(((...e)=>n.previewDigitalHuman&&n.previewDigitalHuman(...e))),d:e.t(o.avatar.name),e:e.t(1==o.avatar.isdefault?"由 官方 创建":"由 "+o.avatar.nicename+" 创建"),f:e.t(1==o.avatar.isdefault?"✓":"👤"),g:e.t(0==o.avatar.isdefault?"未上架":"已上架"),h:1==o.avatar.isdefault?1:"",i:e.t(1==o.avatar.isdefault?"官方":o.avatar.nicename),j:e.t(1==o.avatar.isdefault?"官方":o.avatar.up_user_name||"未知"),k:o.avatar.strictReview?1:"",l:o.avatar.strictReview},o.avatar.strictReview?{m:e.t(o.currentUserId==o.avatar.creator_id?"注意：此数字人开启了严格审核模式，其他人要使用您的数字人合成文案，需要经过您查阅并审核文案后才能合成。":"注意：此数字人开启了严格审核模式，您的文案需要经过所有者审核后才能合成视频。")}:{},{n:e.t(o.avatar.price),o:o.isLoadingAvatar?1:"",p:e.t(o.scriptContent.length),q:o.scriptContent.length>1200?1:"",r:n.getEditDisabled(o.avatar),s:e.o([e=>o.scriptContent=e.detail.value,(...e)=>n.calculateDuration&&n.calculateDuration(...e)]),t:o.scriptContent,v:e.o(((...e)=>n.useTemplate&&n.useTemplate(...e))),w:e.o(((...e)=>n.clearContent&&n.clearContent(...e))),x:o.document.status<=0},o.document.status<=0?{y:e.o(((...e)=>n.saveAsDraft&&n.saveAsDraft(...e)))}:{},{z:e.t(o.estimatedDuration.toFixed(1)),A:e.t(o.calculatedCost),B:e.t(o.userBalance),C:o.userBalance<o.calculatedCost?1:"",D:e.t(n.getActionName(o.avatar)),E:!o.scriptContent.trim()||o.userBalance<o.calculatedCost||o.isLoadingAvatar||n.getActionDisabled(o.avatar),F:!o.scriptContent.trim()||o.userBalance<o.calculatedCost||o.isLoadingAvatar?1:"",G:e.o((e=>n.submitScript(o.avatar))),H:o.showTemplatePopup},o.showTemplatePopup?{I:e.o((e=>o.showTemplatePopup=!1)),J:e.o((e=>o.showTemplatePopup=!1)),K:e.f(o.scriptTemplates,((t,i,a)=>({a:e.t(t.title),b:e.t(t.content.substring(0,50)),c:i,d:e.o((e=>n.applyTemplate(t)),i)})))}:{})}]]);wx.createPage(a);
