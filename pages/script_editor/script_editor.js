"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/config.js"),i={data:()=>({avatarId:"",avatar:{id:"",name:"åŠ è½½ä¸­...",image:"/static/images/placeholder.jpg",owner:"åŠ è½½ä¸­...",price:10,strictReview:!1,preview_video:"",nicename:"",isdefault:0,up_user_name:"",creator_id:0},document:{id:0,status:-1,oss_path:"",generate_video_id:-1},scriptContent:"",estimatedDuration:0,calculatedCost:0,userBalance:0,enableSubtitle:!0,selectedMusicIndex:0,selectedBackgroundIndex:0,showTemplatePopup:!1,scriptTemplates:[{id:1,title:"äº§å“ä»‹ç»æ¨¡æ¿",content:"å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[å§“å]ã€‚ä»Šå¤©æˆ‘è¦ä¸ºå¤§å®¶ä»‹ç»ä¸€æ¬¾é©å‘½æ€§çš„äº§å“â€”[äº§å“åç§°]ã€‚è¿™æ¬¾äº§å“æœ‰ä»¥ä¸‹å‡ ä¸ªçªå‡ºç‰¹ç‚¹ï¼šé¦–å…ˆï¼Œ[ç‰¹ç‚¹ä¸€]ã€‚å…¶æ¬¡ï¼Œ[ç‰¹ç‚¹äºŒ]ã€‚æœ€åï¼Œ[ç‰¹ç‚¹ä¸‰]ã€‚å¦‚æœä½ å¯¹è¿™æ¬¾äº§å“æ„Ÿå…´è¶£ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ¸ é“äº†è§£æ›´å¤šä¿¡æ¯..."},{id:2,title:"æ•™è‚²è¯¾ç¨‹æ¨¡æ¿",content:"æ¬¢è¿æ¥åˆ°[è¯¾ç¨‹åç§°]ã€‚æˆ‘æ˜¯ä½ çš„è®²å¸ˆ[å§“å]ã€‚åœ¨ä»Šå¤©çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å…³äº[ä¸»é¢˜]çš„çŸ¥è¯†ã€‚æˆ‘ä»¬å°†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€ï¼Œ[å†…å®¹ä¸€]ï¼›ç¬¬äºŒï¼Œ[å†…å®¹äºŒ]ï¼›ç¬¬ä¸‰ï¼Œ[å†…å®¹ä¸‰]ã€‚è®©æˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„å­¦ä¹ å§ï¼"},{id:3,title:"ä¼ä¸šå®£ä¼ æ¨¡æ¿",content:"å°Šæ•¬çš„å„ä½æ¥å®¾ï¼Œæ„Ÿè°¢æ‚¨å‚åŠ [å…¬å¸åç§°]çš„å®£ä¼ æ´»åŠ¨ã€‚æˆ‘ä»¬å…¬å¸æˆç«‹äº[å¹´ä»½]ï¼Œä¸“æ³¨äº[ä¸šåŠ¡é¢†åŸŸ]ã€‚ç»è¿‡å¤šå¹´å‘å±•ï¼Œæˆ‘ä»¬å·²æˆä¸ºè¡Œä¸šé¢†å…ˆçš„[æˆå°±æè¿°]ã€‚æˆ‘ä»¬çš„ä½¿å‘½æ˜¯[ä½¿å‘½æè¿°]ï¼Œæˆ‘ä»¬çš„æ„¿æ™¯æ˜¯[æ„¿æ™¯æè¿°]ã€‚æœŸå¾…ä¸æ‚¨åˆä½œå…±èµ¢ï¼"}],isLoadingAvatar:!0,currentUserId:0,generateProgress:0,actionMaps:{0:"ç«‹å³åˆæˆ",1:"æäº¤å®¡æ ¸",2:"å¾…å®¡æ ¸",3:"å·²è¢«æ‹’ç»ï¼Œé‡æ–°ç”³è¯·",4:"å®¡æ ¸é€šè¿‡ï¼Œå»åˆæˆ",5:"åˆæˆä¸­...",6:"å»æ’­æ”¾è§†é¢‘"},progressTimer:null,has_permission:!1}),onLoad(e){console.log("onLoad"),e.avatar_id&&(this.avatarId=e.avatar_id,this.fetchAvatarInfo()),console.log(e),t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID(),this.has_permission=t.hasVideoPermission())})).catch((e=>{console.error("è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)})),e.document_id&&this.getDocumentInfo(e.document_id)},onUnload(){this.progressTimer&&(clearInterval(this.progressTimer),this.progressTimer=null)},methods:{getActionStatus(e){return this.document.status<=0?e.strictReview?1:0:1==this.document.status?this.document.generate_video_id<0?2:4:2==this.document.status?e.strictReview?3:0:3==this.document.status?5:4==this.document.status?6:void 0},getEditDisabled(e){switch(this.getActionStatus(e)){case 2:case 4:case 5:return!0}return!1},getActionDisabled(e){switch(this.getActionStatus(e)){case 2:case 5:return!0}return!1},getActionName(e){let t=this.getActionStatus(e);return 5==t?`åˆæˆä¸­...${this.generateProgress}%`:this.actionMaps[t]},fetchAvatarInfo(){console.log("fetchAvatarInfo"),this.isLoadingAvatar=!0;const i=t.getUserUniToken();e.index.showLoading({title:"åŠ è½½ä¸­..."}),e.index.request({url:t.SERVER_URL+"get_avatar_info",method:"POST",data:{uni_token:i,avatar_id:this.avatarId},success:t=>{if(t.data.code>0&&t.data.avatar){const e=t.data.avatar;this.avatar={id:this.avatarId,name:e.title||"æœªå‘½åæ•°å­—äºº",image:e.preview_image||"/static/images/placeholder.jpg",owner:1==e.isdefault?"å®˜æ–¹":e.nicename||"æœªçŸ¥ç”¨æˆ·",price:e.price_min&&e.price_min>0?e.price_min:10,strictReview:1===e.strict_review,preview_video:e.preview_video||"",nicename:e.nicename||"",isdefault:e.isdefault||0,up_user_name:e.up_user_name||"",creator_id:e.creator_id||0},1==e.isdefault&&(this.avatar.strictReview=!1)}else e.index.showToast({title:t.data.msg||"è·å–æ•°å­—äººä¿¡æ¯å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"è·å–æ•°å­—äººä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"}),console.error("è·å–æ•°å­—äººä¿¡æ¯å¤±è´¥:",t)},complete:()=>{this.isLoadingAvatar=!1,e.index.hideLoading()}})},getDocumentInfo(i){e.index.showLoading({title:"åŠ è½½æ–‡ä»¶ä¸­..."});const a=t.getUserUniToken();e.index.request({url:t.SERVER_URL+"get_document_info",method:"POST",data:{uni_token:a,document_id:i},success:t=>{if(t.data.code>0&&t.data.document_info){console.log(t.data);const a=t.data.document_info;this.document.id=i,this.document.status=a.status,this.document.oss_path=a.oss_path,this.document.generate_video_id=a.generate_video_id,a.oss_path?e.index.request({url:a.oss_path,method:"GET",success:t=>{t.data?(this.scriptContent=t.data,this.calculateDuration()):e.index.showToast({title:"æ–‡ä»¶å†…å®¹ä¸ºç©º",icon:"none"})},fail:t=>{e.index.showToast({title:"åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥",icon:"none"}),console.error("åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥:",t)}}):(this.scriptContent=a.content||"",this.calculateDuration())}else this.document.id=0,e.index.showToast({title:t.data.msg||"è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥",icon:"none"}),console.error("è·å–æ–‡æ¡£ä¿¡æ¯å¤±è´¥:",t)},complete:()=>{e.index.hideLoading()}})},getUserBalance(){this.userBalance=t.getUserBalance()},calculateDuration(){const e=parseFloat(t.estimateDuration(this.scriptContent));this.estimatedDuration=e,this.calculatedCost=t.estimatePoints(this.scriptContent,this.avatar.price)},useTemplate(){this.showTemplatePopup=!0},applyTemplate(e){this.scriptContent=e.content,this.showTemplatePopup=!1,this.calculateDuration()},clearContent(){e.index.showModal({title:"æç¤º",content:"ç¡®å®šè¦æ¸…ç©ºå½“å‰å†…å®¹å—ï¼Ÿ",success:e=>{e.confirm&&(this.scriptContent="",this.calculateDuration())}})},saveAsDraft(){if(!this.scriptContent.trim())return void e.index.showToast({title:"å†…å®¹ä¸èƒ½ä¸ºç©º",icon:"none"});const i=t.getUserUniToken();e.index.showLoading({title:"ä¿å­˜ä¸­..."}),e.index.request({url:t.SERVER_URL+"update_document",method:"POST",data:{uni_token:i,avatar_id:this.avatarId,document_id:this.document.id,text:this.scriptContent},success:t=>{console.log(t),t.data.code>0?(this.document.status=0,this.document.id=t.data.document_id,e.index.showToast({title:"ä¿å­˜æˆåŠŸ",icon:"success"})):e.index.showToast({title:t.data.msg||"ä¿å­˜å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"}),console.error("ä¿å­˜è‰ç¨¿å¤±è´¥:",t)},complete:()=>{e.index.hideLoading()}})},getVideoUrl(e,t){let i;return i=e.endsWith("/")?e+t:e+"/"+t,i},previewDigitalHuman(){if(!this.avatar.preview_video)return void e.index.showToast({title:"æ²¡æœ‰å¯é¢„è§ˆçš„è§†é¢‘",icon:"none"});if(!this.has_permission)return;let t=this.avatar.preview_video;const i=this.getVideoUrl(t,"example.mp4");e.index.navigateTo({url:`/pages/preview/preview?video=${encodeURIComponent(i)}&mainVideo=${encodeURIComponent(this.getVideoUrl(t,"main.mp4"))}&title=${encodeURIComponent(this.avatar.name)}`})},submitScript(i){if(!this.scriptContent.trim())return void e.index.showToast({title:"è¯·å…ˆè¾“å…¥æ–‡æ¡ˆå†…å®¹",icon:"none"});if(this.scriptContent.length<6)return void e.index.showToast({title:"æ–‡æ¡ˆå†…å®¹ä¸èƒ½å°‘äº6ä¸ªå­—",icon:"none"});if(this.scriptContent.length>1800)return void e.index.showToast({title:"æ–‡æ¡ˆå†…å®¹ä¸èƒ½è¶…è¿‡1800ä¸ªå­—",icon:"none"});if(this.userBalance<this.calculatedCost)return void e.index.showModal({title:"ç§¯åˆ†ä¸è¶³",content:"æ‚¨çš„ç§¯åˆ†ä¸è¶³ä»¥ç”Ÿæˆè§†é¢‘ï¼Œè¯·å…ˆå……å€¼",confirmText:"å»å……å€¼",success:t=>{t.confirm&&e.index.navigateTo({url:"/pages/profile/profile"})}});const a=t.getUserUniToken();let s=this.getActionStatus(i);switch(e.index.showLoading({title:1===s?"æäº¤å®¡æ ¸ä¸­...":"åˆæˆå¤„ç†ä¸­..."}),s){case 0:e.index.request({url:t.SERVER_URL+"synthesize_video_strict",method:"POST",data:{uni_token:a,avatar_id:this.avatarId,text:this.scriptContent,document_id:this.document.id},success:i=>{i.data.code>0?(t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID())})).catch((e=>{console.error("è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)})),this.document.id=i.data.task_id,this.document.generate_video_id=-1,this.document.status=3,e.index.showToast({title:"æäº¤æˆåŠŸï¼Œå¼€å§‹åˆæˆ",icon:"success",duration:2e3}),this.getGenerateProgress()):e.index.showToast({title:i.data.msg||"æäº¤å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"}),console.error("æäº¤æ–‡æ¡ˆå¤±è´¥:",t)},complete:()=>{e.index.hideLoading()}});break;case 1:case 3:e.index.request({url:t.SERVER_URL+"submit_script_for_approval",method:"POST",data:{uni_token:a,avatar_id:this.avatarId,text:this.scriptContent,document_id:this.document.id},success:t=>{t.data.code>0?(this.document.id=t.data.task_id,this.document.status=1,this.document.generate_video_id=-1,e.index.showModal({title:"æäº¤æˆåŠŸ",content:"æ‚¨çš„æ–‡æ¡ˆå·²æäº¤å®¡æ ¸ï¼Œç­‰å¾…æ•°å­—äººæ‰€æœ‰è€…å®¡æ ¸åæ‰èƒ½å»åˆæˆè§†é¢‘",showCancel:!1})):e.index.showToast({title:t.data.msg||"æäº¤å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"}),console.error("æäº¤æ–‡æ¡ˆå¤±è´¥:",t)},complete:()=>{e.index.hideLoading()}});break;case 2:case 5:break;case 4:e.index.request({url:t.SERVER_URL+"synthesize_video_for_approved",method:"POST",data:{uni_token:a,document_id:this.document.id},success:i=>{i.data.code>0?(t.getLatestUserInfo().then((e=>{e&&(console.log(e),this.getUserBalance(),this.currentUserId=t.getUserID())})).catch((e=>{console.error("è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",e)})),this.document.id=i.data.task_id,this.document.generate_video_id=-1,this.document.status=3,e.index.showToast({title:"å¼€å§‹åˆæˆè§†é¢‘",icon:"success"}),this.getGenerateProgress()):e.index.showToast({title:i.data.msg||"åˆæˆè¯·æ±‚å¤±è´¥",icon:"none"})},fail:t=>{e.index.showToast({title:"åˆæˆè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",icon:"none"}),console.error("åˆæˆè§†é¢‘è¯·æ±‚å¤±è´¥:",t)},complete:()=>{e.index.hideLoading()}});break;case 6:this.document.generate_video_id>0?this.getVideoInfo(this.document.generate_video_id):(e.index.hideLoading(),e.index.showToast({title:"è§†é¢‘IDä¸å­˜åœ¨",icon:"none"}))}},getGenerateProgress(){const e=()=>{t.getGenerateProgress((e=>{e.error?console.error("è·å–è¿›åº¦å¤±è´¥:",e.error):e.taskId>0&&(this.generateProgress=e.progress,this.processing_task_id=e.taskId,e.isComplete&&(clearInterval(this.progressTimer),this.progressTimer=null,setTimeout((()=>{this.getDocumentInfo(this.document.id)}),5e3)))}))};e(),this.progressTimer||(this.progressTimer=setInterval(e,5e3))},getVideoInfo(i){if(!i)return;const a=t.getUserUniToken();e.index.showLoading({title:"è·å–è§†é¢‘ä¿¡æ¯..."}),e.index.request({url:this.$serverUrl+"get_generate_video",method:"POST",data:{uni_token:a,video_id:i},success:t=>{var i;if(e.index.hideLoading(),t.data.code>0&&t.data.videoData&&t.data.videoData.full_file_path){const a=t.data.videoData.full_file_path,s=t.data.videoData.filename||(null==(i=this.avatar)?void 0:i.title)||"è§†é¢‘é¢„è§ˆ";e.index.navigateTo({url:`/pages/preview/preview?video=${encodeURIComponent(a)}&title=${encodeURIComponent(s)}&download=true`})}else e.index.showToast({title:"è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾",icon:"none"})},fail:t=>{e.index.hideLoading(),console.error("è·å–è§†é¢‘ä¿¡æ¯å‡ºé”™:",t),e.index.showToast({title:"è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}})}}};const a=e._export_sfc(i,[["render",function(t,i,a,s,o,n){return e.e({a:o.avatar.image,b:o.has_permission},(o.has_permission,{}),{c:e.o(((...e)=>n.previewDigitalHuman&&n.previewDigitalHuman(...e))),d:e.t(o.avatar.name),e:e.t(1==o.avatar.isdefault?"ç”± å®˜æ–¹ åˆ›å»º":"ç”± "+o.avatar.nicename+" åˆ›å»º"),f:e.t(1==o.avatar.isdefault?"âœ“":"ğŸ‘¤"),g:e.t(0==o.avatar.isdefault?"æœªä¸Šæ¶":"å·²ä¸Šæ¶"),h:1==o.avatar.isdefault?1:"",i:e.t(1==o.avatar.isdefault?"å®˜æ–¹":o.avatar.nicename),j:e.t(1==o.avatar.isdefault?"å®˜æ–¹":o.avatar.up_user_name||"æœªçŸ¥"),k:o.avatar.strictReview?1:"",l:o.avatar.strictReview},o.avatar.strictReview?{m:e.t(o.currentUserId==o.avatar.creator_id?"æ³¨æ„ï¼šæ­¤æ•°å­—äººå¼€å¯äº†ä¸¥æ ¼å®¡æ ¸æ¨¡å¼ï¼Œå…¶ä»–äººè¦ä½¿ç”¨æ‚¨çš„æ•°å­—äººåˆæˆæ–‡æ¡ˆï¼Œéœ€è¦ç»è¿‡æ‚¨æŸ¥é˜…å¹¶å®¡æ ¸æ–‡æ¡ˆåæ‰èƒ½åˆæˆã€‚":"æ³¨æ„ï¼šæ­¤æ•°å­—äººå¼€å¯äº†ä¸¥æ ¼å®¡æ ¸æ¨¡å¼ï¼Œæ‚¨çš„æ–‡æ¡ˆéœ€è¦ç»è¿‡æ‰€æœ‰è€…å®¡æ ¸åæ‰èƒ½åˆæˆè§†é¢‘ã€‚")}:{},{n:e.t(o.avatar.price),o:o.isLoadingAvatar?1:"",p:e.t(o.scriptContent.length),q:o.scriptContent.length>1200?1:"",r:n.getEditDisabled(o.avatar),s:e.o([e=>o.scriptContent=e.detail.value,(...e)=>n.calculateDuration&&n.calculateDuration(...e)]),t:o.scriptContent,v:e.o(((...e)=>n.useTemplate&&n.useTemplate(...e))),w:e.o(((...e)=>n.clearContent&&n.clearContent(...e))),x:o.document.status<=0},o.document.status<=0?{y:e.o(((...e)=>n.saveAsDraft&&n.saveAsDraft(...e)))}:{},{z:e.t(o.estimatedDuration.toFixed(1)),A:e.t(o.calculatedCost),B:e.t(o.userBalance),C:o.userBalance<o.calculatedCost?1:"",D:e.t(n.getActionName(o.avatar)),E:!o.scriptContent.trim()||o.userBalance<o.calculatedCost||o.isLoadingAvatar||n.getActionDisabled(o.avatar),F:!o.scriptContent.trim()||o.userBalance<o.calculatedCost||o.isLoadingAvatar?1:"",G:e.o((e=>n.submitScript(o.avatar))),H:o.showTemplatePopup},o.showTemplatePopup?{I:e.o((e=>o.showTemplatePopup=!1)),J:e.o((e=>o.showTemplatePopup=!1)),K:e.f(o.scriptTemplates,((t,i,a)=>({a:e.t(t.title),b:e.t(t.content.substring(0,50)),c:i,d:e.o((e=>n.applyTemplate(t)),i)})))}:{})}]]);wx.createPage(a);
