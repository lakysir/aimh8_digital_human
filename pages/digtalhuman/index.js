"use strict";const e=require("../../common/vendor.js"),a={onShareAppMessage(a){let t="default";t=a.target.id;const o=e.index.getStorageSync("user_id"),i=e.index.getStorageSync("nicename");return"inviteDoctor"===t?{title:`${i}邀请您成为他的版权方`,path:`/pages/register/index?invite_id=${o}`,imageUrl:""}:"bindOperate"===t?{title:`${i}申请绑定成为您的推广者`,path:`/pages/register/index?request_bind_operate=${o}`,imageUrl:""}:void 0}},t=Object.assign(a,{__name:"index",setup(a){const t=e.ref(""),o=e.ref(""),i=e.ref(""),n=e.ref(!1),s=e.ref(!1),d=e.ref([]),l=e.ref([]),r=e.ref(null),u=e.ref(""),c=e.ref(""),v=e.index.getStorageSync("phoneNum"),g=e.index.getStorageSync("user_id"),h=e.index.getStorageSync("nicename"),m=e.ref(0);m.value=e.index.getStorageSync("benefit");const x=3e3,p=e.ref(""),w=e.ref(""),_=e.computed((()=>t.value&&o.value&&i.value&&""!==p.value.trim())),f=()=>{n.value=!n.value,s.value=!1},y=()=>{s.value=!s.value,n.value=!1},S=()=>{e.index.showLoading({title:"视频添加中...",mask:!0}),e.wx$1.chooseMedia({count:1,mediaType:["video"],sourceType:["album"],success(a){const t=a.tempFiles[0];console.log(t);if(Math.max(t.width,t.height)>1920)return void e.index.showToast({title:"添加失败:分辨率超过1080P",icon:"none"});t.size/1048576>800?e.index.showToast({title:"添加失败:视频超过800MB",icon:"none"}):t.duration>360?e.index.showToast({title:"添加失败:视频时长超过6分钟",icon:"none"}):(r.value=t.tempFilePath,i.value=t.thumbTempFilePath,e.index.hideLoading())},fail:a=>{console.log(a),e.index.hideLoading(),e.index.showToast({title:"选择视频失败",icon:"none"})}})},T=async()=>{try{if(!_.value)return void e.index.showToast({title:"请填写完整信息",icon:"none"});if(c.value===g){if(m.value<x)return void e.index.showToast({title:"您的钱包余额不足3000U，请先充值再申请制作",icon:"none"});e.index.showModal({title:"确认提示",content:"本次申请将扣除您3000U，是否确认？",success:e=>{e.confirm&&b()}})}else{const a=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{searchRequestForkCnt:!0,username:v,user_id:g}});if(console.log(a.data),a.data.code<0||a.data.requesting_cnt>=5)return void e.index.showToast({title:"正在审批的制作数量超过5个，无法申请制作!请先撤销或者等待审核完毕!",icon:"none"});b()}}catch(a){e.index.showToast({title:"申请数字人制作失败",icon:"none"}),console.log(a)}},b=async()=>{e.index.showLoading({title:"上传视频..."});const a=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{oss_stoken:1,username:v,user_id:g}});if(a.data.code<0)return void e.index.showToast({title:"获取OSS Token失败",icon:"none"});const t=g+"_"+a.data.ossdata.x_oss_date+".mp4",o={key:"data/config/diymuban/"+t,policy:a.data.ossdata.policy,"x-oss-signature-version":a.data.ossdata.x_oss_signature_version,"x-oss-credential":a.data.ossdata.x_oss_credential,"x-oss-date":a.data.ossdata.x_oss_date,"x-oss-signature":a.data.ossdata.signature,"x-oss-security-token":a.data.ossdata.security_token,success_action_status:"200"};e.wx$1.uploadFile({url:"https://foco-aimh8.oss-cn-hangzhou.aliyuncs.com",filePath:r.value,name:"file",formData:o,success(a){200===a.statusCode?e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{submitDigitalHuman:!0,username:v,user_id:g,owner_id:u.value,operator_id:c.value,video_url:t,title:p.value,cost:x},success:a=>{a.data.code>=0?(c.value==g&&(m.value=m.value-x,e.index.setStorageSync("benefit",m.value)),e.index.showToast({title:"提交成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500)):e.index.showToast({title:a.data.msg||"提交失败",icon:"none"})},fail:a=>{e.index.showToast({title:"提交失败3:"+a.errMsg,icon:"none"})}}):e.index.showToast({title:"上传失败1:res.statusCode",icon:"none"})},fail(a){e.index.showToast({title:"上传失败2:"+a.errMsg,icon:"none"})},progress(a){const t=Math.floor(100*a.progress/a.totalBytesExpectedToSend);e.index.showLoading({title:`上传中... ${t}%`})}})};return e.onMounted((()=>{w.value=e.index.getStorageSync("user_type"),console.log(w),(null==w.value||w.value<=0)&&e.index.navigateTo({url:"/pages/main/index"}),e.index.showLoading({title:"加载医生和代运营列表..."}),(async()=>{try{const a=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{getMyDoctorAndOperators:!0,username:v,user_id:g,partner_id:e.index.getStorageSync("partner_id"),user_type:e.index.getStorageSync("user_type")}});console.log(a.data),a.data.code>=0&&(d.value=[{id:g,name:"我自己",originalName:h},...a.data.doctors.map((e=>({id:e[0],name:e[1],originalName:e[1]})))],l.value=[{id:g,name:"我自己",originalName:h},...a.data.operators.map((e=>({id:e[0],name:e[1],originalName:e[1]})))])}catch(a){e.index.showToast({title:"获取版权和代运营失败",icon:"none"})}})(),e.index.hideLoading()})),(a,r)=>e.e({a:e.t(t.value||"请选择"),b:n.value},n.value?{c:e.f(d.value,((a,o,i)=>({a:e.t(a.name),b:a.id,c:e.o((e=>(e=>{t.value=e.name,u.value=e.id,p.value=e.originalName,n.value=!1})(a)),a.id)})))}:{},{d:e.o(f),e:e.t(o.value||"请选择"),f:s.value},s.value?{g:e.f(l.value,((a,t,i)=>({a:e.t(a.name),b:a.id,c:e.o((e=>(e=>{if(e.isInvite)return s.value=!1,void scanQRCode();o.value=e.name,c.value=e.id,s.value=!1})(a)),a.id)})))}:{},{h:e.o(y),i:i.value},i.value?{j:i.value}:{},{k:e.o(S),l:p.value,m:e.o((e=>p.value=e.detail.value)),n:e.o(T),o:!_.value})}});t.__runtimeHooks=2,wx.createPage(t);
