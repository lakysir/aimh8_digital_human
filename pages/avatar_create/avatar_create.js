"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/config.js"),s={data:()=>({videoFile:"",videoThumbnail:"",videoFilename:"",videoSizeText:"",videoDurationText:"",showProgress:!1,progressPercentage:0,uploadedSize:0,totalSize:0,uploadTask:null,digitalHumanName:"",digitalHumanDesc:"",agreeToUse:!1,agreeToRights:!1,agreeToTerms:!1,showNameError:!1,showDescError:!1,showBalanceModal:!1,showSuccessModal:!1,userId:"",userBalance:0,clone_cost:3e3}),computed:{isFormValid(){return this.videoFile&&""!==this.digitalHumanName.trim()&&this.digitalHumanName.length<=10&&this.digitalHumanDesc.length<=50&&this.agreeToUse&&this.agreeToRights&&this.agreeToTerms}},onLoad(){this.userId=o.getUserID(),o.getLatestUserInfo().then((e=>{e&&(console.log(e),this.userBalance=o.getUserBalance())})).catch((e=>{console.error("获取最新用户信息失败:",e)}))},methods:{chooseVideo(){e.index.showLoading({title:"视频添加中...",mask:!0}),e.wx$1.chooseMedia({count:1,mediaType:["video"],sourceType:["album"],success:o=>{const s=o.tempFiles[0];console.log(s);if(Math.max(s.width,s.height)>1920)return e.index.showToast({title:"添加失败:分辨率超过1080P",icon:"none"}),void e.index.hideLoading();const a=s.size/1048576;if(a>800)return e.index.showToast({title:"添加失败:视频超过800MB",icon:"none"}),void e.index.hideLoading();if(s.duration>600)return e.index.showToast({title:"添加失败:视频时长超过10分钟",icon:"none"}),void e.index.hideLoading();if(s.duration<180)return e.index.showToast({title:"添加失败:视频时长少于3分钟",icon:"none"}),void e.index.hideLoading();this.videoFile=s.tempFilePath,this.videoThumbnail=s.thumbTempFilePath;const i=s.tempFilePath.split("/");this.videoFilename=i[i.length-1],this.videoSizeText=a.toFixed(2)+"MB";const t=Math.floor(s.duration/60),n=Math.floor(s.duration%60);this.videoDurationText=`${t}:${n<10?"0"+n:n}`,e.index.hideLoading()},fail:o=>{console.log(o),e.index.hideLoading(),e.index.showToast({title:"选择视频失败",icon:"none"})}})},deleteVideo(){this.videoFile="",this.videoThumbnail="",this.videoFilename="",this.videoSizeText="",this.videoDurationText=""},cancelUpload(){this.uploadTask&&(this.uploadTask.abort(),this.uploadTask=null),this.showProgress=!1,e.index.showToast({title:"上传已取消",icon:"none"})},confirmUpload(){this.isFormValid?this.showBalanceModal=!0:e.index.showToast({title:"请填写完整信息并同意条款",icon:"none"})},closeBalanceModal(){this.showBalanceModal=!1},startUpload(){if(this.userBalance<this.clone_cost)return this.closeBalanceModal(),void e.index.showModal({title:"余额不足",content:"您的余额不足，请联系您的运营商充值",showCancel:!1});this.closeBalanceModal(),this.startUploadProcess()},async startUploadProcess(){e.index.showLoading({title:"上传视频..."});try{const s=o.getUserUniToken(),a=await e.index.request({url:o.SERVER_URL+"get_oss_token_policy",method:"POST",data:{},header:{"Content-Type":"application/json"}});if(a.data.code<0)return e.index.hideLoading(),void e.index.showToast({title:"获取上传凭证失败",icon:"none"});const i="data/config/diymuban/",t=this.userId+"_"+a.data.ossdata.x_oss_date+".mp4",n={key:i+t,policy:a.data.ossdata.policy,"x-oss-signature-version":a.data.ossdata.x_oss_signature_version,"x-oss-credential":a.data.ossdata.x_oss_credential,"x-oss-date":a.data.ossdata.x_oss_date,"x-oss-signature":a.data.ossdata.signature,"x-oss-security-token":a.data.ossdata.security_token,success_action_status:"200"};this.showProgress=!0,this.progressPercentage=0;const d=await this.getFileInfo(this.videoFile);this.totalSize=(d.size/1048576).toFixed(2),this.uploadedSize=0,console.log(n),this.uploadTask=e.wx$1.uploadFile({url:"https://foco-aimh8.oss-cn-hangzhou.aliyuncs.com",filePath:this.videoFile,name:"file",formData:n,success:a=>{if(console.log(a),200===a.statusCode){const a={muban_title:this.digitalHumanName,description:this.digitalHumanDesc,video_oss_path:t,in_market:0,price_min:10,strict_review:1,uni_token:s};e.index.request({url:o.SERVER_URL+"avatar_video_submit",method:"POST",data:a,success:s=>{s.data.code>=0?(o.getLatestUserInfo().then((e=>{e&&(console.log(e),this.userBalance=o.getUserBalance())})).catch((e=>{console.error("获取最新用户信息失败:",e)})),this.showSuccessModal=!0):e.index.showToast({title:s.data.msg||"提交失败",icon:"none"})},fail:o=>{e.index.showToast({title:"提交失败:"+o.errMsg,icon:"none"})}})}else e.index.showToast({title:"上传失败:"+a.statusCode,icon:"none"})},fail:o=>{-1===o.errMsg.indexOf("abort")&&e.index.showToast({title:"上传失败:"+o.errMsg,icon:"none"})},complete:()=>{e.index.hideLoading(),this.showProgress=!1,this.uploadTask=null},progress:o=>{const s=Math.floor(100*o.progress/o.totalBytesExpectedToSend);this.progressPercentage=s,this.uploadedSize=(o.totalBytesSent/1048576).toFixed(2),e.index.showLoading({title:`上传中... ${s}%`})}})}catch(s){e.index.hideLoading(),this.showProgress=!1,e.index.showToast({title:"上传失败："+s.message,icon:"none"})}},getFileInfo:o=>new Promise(((s,a)=>{e.index.getFileInfo({filePath:o,success:e=>{s(e)},fail:e=>{a(e)}})})),goToTerms(){e.index.navigateTo({url:"/pages/agreement/user_agreement"})},goToPrivacy(){e.index.navigateTo({url:"/pages/agreement/privacy_policy"})},goBack(){this.showSuccessModal=!1,e.index.navigateBack()}}};const a=e._export_sfc(s,[["render",function(o,s,a,i,t,n){return e.e({a:!t.videoFile},(t.videoFile,{}),{b:t.videoFile},t.videoFile?{c:t.videoThumbnail||"/static/images/video-placeholder.jpg",d:e.t(t.videoFilename),e:e.t(t.videoSizeText),f:e.t(t.videoDurationText),g:e.o(((...e)=>n.deleteVideo&&n.deleteVideo(...e)))}:{},{h:e.o(((...e)=>n.chooseVideo&&n.chooseVideo(...e))),i:t.showProgress},t.showProgress?{j:e.t(t.progressPercentage),k:e.o(((...e)=>n.cancelUpload&&n.cancelUpload(...e))),l:t.progressPercentage+"%",m:e.t(t.videoFilename),n:e.t(t.uploadedSize),o:e.t(t.totalSize)}:{},{p:t.digitalHumanName,q:e.o((e=>t.digitalHumanName=e.detail.value)),r:e.t(t.digitalHumanName.length),s:t.showNameError},(t.showNameError,{}),{t:t.digitalHumanDesc,v:e.o((e=>t.digitalHumanDesc=e.detail.value)),w:e.t(t.digitalHumanDesc.length),x:t.showDescError},(t.showDescError,{}),{y:t.agreeToUse,z:e.o((e=>t.agreeToUse=!t.agreeToUse)),A:t.agreeToRights,B:e.o((e=>t.agreeToRights=!t.agreeToRights)),C:t.agreeToTerms,D:e.o((e=>t.agreeToTerms=!t.agreeToTerms)),E:e.o(((...e)=>n.goToTerms&&n.goToTerms(...e))),F:e.o(((...e)=>n.goToPrivacy&&n.goToPrivacy(...e))),G:n.isFormValid?"":1,H:!n.isFormValid,I:e.o(((...e)=>n.confirmUpload&&n.confirmUpload(...e))),J:t.showBalanceModal},t.showBalanceModal?e.e({K:e.o(((...e)=>n.closeBalanceModal&&n.closeBalanceModal(...e))),L:e.t(t.userBalance),M:t.userBalance<3e3},(t.userBalance,{}),{N:e.o(((...e)=>n.closeBalanceModal&&n.closeBalanceModal(...e))),O:e.t(t.userBalance<3e3?"去充值":"确认使用"),P:t.userBalance<3e3?1:"",Q:t.userBalance<3e3,R:e.o(((...e)=>n.startUpload&&n.startUpload(...e)))}):{},{S:t.showSuccessModal},t.showSuccessModal?{T:e.t(t.digitalHumanName),U:e.o(((...e)=>n.goBack&&n.goBack(...e)))}:{})}]]);wx.createPage(a);
