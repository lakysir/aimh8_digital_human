"use strict";const t=require("../../common/vendor.js"),e=require("../../utils/config.js"),i=require("../../common/assets.js"),a={data:()=>({currentTab:"pending",tabs:[{id:"pending",name:"待审核"},{id:"approved",name:"已通过"},{id:"rejected",name:"已拒绝"}],stats:{pending:0,approved:0,rejected:0},scripts:[],currentPage:1,pageSize:10,hasMoreData:!0,isLoading:!1,totalPages:1}),computed:{filteredScripts(){return console.log("过滤脚本:",{tab:this.currentTab,scripts:this.scripts}),this.scripts},emptyStateText(){return"pending"===this.currentTab?"暂无待审核文案":"approved"===this.currentTab?"暂无已通过文案":"暂无已拒绝文案"}},mounted(){this.fetchScriptList()},methods:{fetchScriptList(){this.currentPage=1,this.hasMoreData=!0,this.scripts=[],this.getUserReviewList(this.currentPage)},handleTabChange(t){this.currentTab!==t&&(console.log("切换标签页:",{from:this.currentTab,to:t}),this.currentTab=t,this.scripts=[],this.fetchScriptList())},loadMore(){!this.isLoading&&this.hasMoreData&&(this.currentPage++,this.getUserReviewList(this.currentPage,!0))},getUserReviewList(i=1,a=!1){const s=e.getUserUniToken();if(!s)return console.error("获取用户token失败"),void t.index.showToast({title:"获取用户信息失败",icon:"none"});let n=1;"approved"===this.currentTab?n=2:"rejected"===this.currentTab&&(n=3),console.log("请求类型:",{tab:this.currentTab,documentsType:n}),this.isLoading=!0,a||t.index.showLoading({title:"加载中"});const o={uni_token:s,documents_type:n,page:i,page_size:this.pageSize};t.index.request({url:e.SERVER_URL+"get_approval_documents",method:"POST",data:o,success:e=>{e.data&&e.data.code>0?(console.log("获取审核列表返回数据:",e.data),this.processResponseData(e.data,a)):(console.error("获取审核列表失败:",e.data),t.index.showToast({title:e.data&&e.data.msg?e.data.msg:"获取数据失败",icon:"none"}),a||(this.scripts=[]),this.hasMoreData=!1)},fail:e=>{console.error("获取审核列表请求失败:",e),t.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{this.isLoading=!1,a||t.index.hideLoading()}})},processResponseData(t,i){var a;if(!t)return i||(this.scripts=[]),void(this.hasMoreData=!1);console.log("处理返回数据:",t);let s=t.items||t.list;if(Array.isArray(t)?s=t:t.data&&Array.isArray(t.data)&&(s=t.data),t.stats&&(this.stats={pending:t.stats.pending||0,approved:t.stats.approved||0,rejected:t.stats.rejected||0}),this.totalPages=t.total_pages||(null==(a=t.pagination)?void 0:a.total_pages)||1,this.hasMoreData=this.currentPage<this.totalPages,!s||0===s.length)return i||(this.scripts=[]),void(this.hasMoreData=!1);console.log("处理的列表项:",s);const n=s.map((t=>{console.log("处理单个项的原始数据:",t);let i=10;void 0!==t.muban_price_min?i=t.muban_price_min:void 0!==t.price?i=t.price:void 0!==t.unit_price&&(i=t.unit_price),console.log("提取的价格值:",i);let a=this.currentTab;const s=e.estimateDuration(t.content||""),n=e.estimatePoints_income(t.content||"",i);return{id:t.id||"",avatarId:t.muban_id||"",avatarName:t.muban_name||t.user_name||"默认模板",avatarImage:t.muban_preview||t.user_avatar||"/static/images/default-avatar.jpg",applicant:t.creator_name||t.user_name||"未知用户",title:t.title||"无标题",content:t.content||"",status:a,rawStatus:t.status,rawGenerateVideoId:t.generate_video_id,submitTime:t.create_time?new Date(1e3*t.create_time).getTime():t.created_at?new Date(t.created_at).getTime():(new Date).getTime(),estimatedDuration:s,credits:n,muban_price_min:i,documentPath:t.document_path||"",expanded:!1,isContentLoading:!1}}));console.log("创建的脚本列表:",n),this.scripts=i?[...this.scripts,...n]:n,console.log("最终的脚本列表:",this.scripts),0!==this.scripts.length||i||(console.log("API返回数据处理后为空，使用默认数据"),this.scripts=[{id:"default-1",avatarId:"avatar1",avatarName:"默认模板",avatarImage:"/static/images/default-avatar.jpg",applicant:"示例用户",title:"示例文案标题",content:"这是一个示例文案内容，当API返回为空时显示。实际使用时会显示真实的审核文案。",status:this.currentTab,submitTime:(new Date).getTime(),estimatedDuration:1,credits:30,muban_price_min:30,expanded:!1}])},mapStatusToApp(t,e){return console.log("映射状态:",{status:t,generateVideoId:e}),t=void 0!==t?Number(t):1,e=void 0!==e?Number(e):-1,"approved"===this.currentTab?"approved":"rejected"===this.currentTab?"rejected":"pending"===this.currentTab||1===t&&e<0?"pending":2===t||1===t&&e>0?"approved":3===t?"rejected":"pending"},formatTime(t){if(!t)return"";const e=new Date(t);return`${e.getFullYear()}/${this.padZero(e.getMonth()+1)}/${this.padZero(e.getDate())} ${this.padZero(e.getHours())}:${this.padZero(e.getMinutes())}`},padZero:t=>t<10?`0${t}`:t,getStatusClass:t=>({pending:"status-pending",approved:"status-approved",rejected:"status-rejected"}[t]||"status-pending"),getStatusText(t){return"pending"===t?"待审核":"approved"===t?"已通过":"rejected"===t?"已拒绝":"approved"===this.currentTab?"已通过":"rejected"===this.currentTab?"已拒绝":"待审核"},toggleScript(t){const e=this.scripts.find((e=>e.id===t));e&&(e.expanded=!e.expanded,e.expanded&&e.documentPath&&!e.contentLoaded&&this.loadScriptContent(e))},loadScriptContent(i){i.documentPath?(console.log("加载文档内容:",i.documentPath),console.log("脚本对象:",{id:i.id,title:i.title,price:i.muban_price_min}),i.isContentLoading=!0,t.index.request({url:i.documentPath,success:a=>{if(200===a.statusCode&&a.data){console.log("文档内容加载成功"),i.content=a.data,i.contentLoaded=!0;const t=void 0!==i.muban_price_min?i.muban_price_min:10;i.estimatedDuration=e.estimateDuration(a.data),i.credits=e.estimatePoints_income(a.data,t),console.log("估算时长:",i.estimatedDuration),console.log("使用的价格:",t),console.log("计算的积分:",i.credits),console.log("更新后的脚本内容:",{content:i.content.substring(0,50)+"...",duration:i.estimatedDuration,credits:i.credits})}else console.error("文档内容加载失败:",a),t.index.showToast({title:"加载文案内容失败",icon:"none"})},fail:e=>{console.error("获取文案内容失败:",e),t.index.showToast({title:"加载文案内容失败",icon:"none"})},complete:()=>{i.isContentLoading=!1}})):console.log("无文档路径，跳过加载")},getAvatarName:t=>t.avatarName&&""!==t.avatarName.trim()?t.avatarName:"默认模板",approveScript(e){t.index.showModal({title:"通过审核",content:"确定要通过该文案审核吗？",success:t=>{t.confirm&&this.submitApproval(e)}})},rejectScript(e){t.index.showModal({title:"拒绝审核",content:"",editable:!0,placeholderText:"请输入拒绝原因",success:i=>{if(i.confirm){if(!i.content||""===i.content.trim())return void t.index.showToast({title:"请填写拒绝原因",icon:"none"});this.submitRejection(e,i.content)}}})},submitApproval(i){const a=this.scripts.find((t=>t.id===i));if(!a)return;const s=e.getUserUniToken();if(!s)return void t.index.showToast({title:"获取用户信息失败",icon:"none"});t.index.showLoading({title:"处理中"});const n={uni_token:s,document_id:i};t.index.request({url:e.SERVER_URL+"approve_document",method:"POST",data:n,success:e=>{e.data&&e.data.code>0?(a.status="approved",this.stats.pending-=1,this.stats.approved+=1,t.index.showToast({title:"已通过审核",icon:"success"}),setTimeout((()=>{this.fetchScriptList()}),1e3)):(console.error("审核操作失败:",e.data),t.index.showToast({title:e.data&&e.data.msg?e.data.msg:"操作失败",icon:"none"}))},fail:e=>{console.error("审核操作请求失败:",e),t.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{t.index.hideLoading()}})},submitRejection(i,a){const s=this.scripts.find((t=>t.id===i));if(!s)return;const n=e.getUserUniToken();if(!n)return void t.index.showToast({title:"获取用户信息失败",icon:"none"});t.index.showLoading({title:"处理中"});const o={uni_token:n,document_id:i,review_comment:a};console.log("拒绝审核请求参数:",o),t.index.request({url:e.SERVER_URL+"reject_document",method:"POST",data:o,success:e=>{e.data&&e.data.code>0?(s.status="rejected",this.stats.pending-=1,this.stats.rejected+=1,t.index.showToast({title:"已拒绝",icon:"none"}),setTimeout((()=>{this.fetchScriptList()}),1e3)):(console.error("拒绝操作失败:",e.data),t.index.showToast({title:e.data&&e.data.msg?e.data.msg:"操作失败",icon:"none"}))},fail:e=>{console.error("拒绝审核请求失败:",e),t.index.showToast({title:"网络请求失败",icon:"none"})},complete:()=>{t.index.hideLoading()}})}}};if(!Array){(t.resolveComponent("circle")+t.resolveComponent("polyline")+t.resolveComponent("svg"))()}const s=t._export_sfc(a,[["render",function(e,a,s,n,o,r){return t.e({a:t.f(o.tabs,((e,i,a)=>({a:t.t(e.name),b:i,c:o.currentTab===e.id?1:"",d:t.o((t=>r.handleTabChange(e.id)),i)}))),b:r.filteredScripts.length>0},r.filteredScripts.length>0?t.e({c:t.f(r.filteredScripts,((e,i,a)=>t.e({a:e.avatarImage,b:t.t(e.applicant),c:t.t(r.formatTime(e.submitTime)),d:t.t(r.getAvatarName(e)),e:t.t(r.getStatusText(e.status)),f:t.n(r.getStatusClass(e.status)),g:t.t(e.expanded?"∧":"∨"),h:t.o((t=>r.toggleScript(e.id)),i),i:e.expanded},e.expanded?t.e({j:e.isContentLoading},e.isContentLoading?{}:t.e({k:t.t(e.title||"大家好，我是一名AI"),l:t.t(e.content),m:"bf99d966-1-"+a+",bf99d966-0-"+a,n:t.p({cx:"12",cy:"12",r:"10"}),o:"bf99d966-2-"+a+",bf99d966-0-"+a,p:t.p({points:"12 6 12 12 16 14"}),q:"bf99d966-0-"+a,r:t.p({xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),s:t.t(e.estimatedDuration),t:"bf99d966-4-"+a+",bf99d966-3-"+a,v:t.p({cx:"9",cy:"9",r:"5"}),w:"bf99d966-5-"+a+",bf99d966-3-"+a,x:t.p({cx:"15",cy:"15",r:"5"}),y:"bf99d966-3-"+a,z:t.p({xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),A:t.t(e.credits),B:"pending"===e.status},"pending"===e.status?{C:t.o((t=>r.rejectScript(e.id)),i),D:t.o((t=>r.approveScript(e.id)),i)}:{})):{},{E:i}))),d:o.isLoading},o.isLoading?{}:o.hasMoreData?{f:t.o(((...t)=>r.loadMore&&r.loadMore(...t)))}:{},{e:o.hasMoreData}):{g:i._imports_0$3,h:t.t(r.emptyStateText)})}]]);wx.createPage(s);
