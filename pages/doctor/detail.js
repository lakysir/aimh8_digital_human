"use strict";const e=require("../../common/vendor.js"),t={__name:"detail",setup(t){const n=e.index.getStorageSync("phoneNum"),a=e.index.getStorageSync("user_id"),o=e.ref(""),s=e.ref([]),c=e.ref(0),i=e.ref(0),l=e.ref(""),r=e.ref(""),u=e.ref(0);var d=null;const v=e.ref(!1);var g,p=!1;const m=()=>{e.nextTick$1((()=>{e.index.createSelectorQuery().select("#chat-content").boundingClientRect((e=>{c.value=e.height})).exec()}))};function h(e){const t=e.match(/!\[photo\]\((https?:\/\/[^\s]+)?\)/);if(!t)return null;const n=t[1];return n||"nopic"}e.onMounted((async()=>{e.index.showLoading({title:"正在加载..",mask:!0});const t=getCurrentPages(),o=t[t.length-1].options.id;console.log("agent_id:",o);try{const t=await e.index.request({url:"https://www.aimh8.com/agent/api",method:"POST",header:{"Content-Type":"application/json"},data:{api_name:"get_agent_info",agent_id:o,user_id:a,username:n}});console.log("get_agent_info 返回数据:",t.data),t.data.code>=0&&(d=t.data.agent_info,e.wx$1.setNavigationBarTitle({title:d.name}),l.value=d.opening_remarks,r.value=d.bot_id,u.value=t.data.convertion_id,console.log("conversion_id:",u.value),console.log("bot_id:",r.value),t.data.messages&&t.data.messages.data&&t.data.messages.data.reverse().forEach((e=>{const t=h(e.content);"nopic"!=t&&(s.value.length>0&&0==d.continues&&s.value[s.value.length-1].type==e.role?s.value[s.value.length-1].content+=e.content:"assistant"==e.role?s.value.push({type:"assistant",content:t||e.content,contentType:t?"image":"text",avatar:d.icon}):"user"==e.role&&s.value.push({type:"user",content:t||e.content,contentType:t?"image":"text",avatar:d.icon}))})),m()),g=e.wx$1.connectSocket({url:"wss://www.aimh8.com/wss/",success:()=>{console.log("WebSocket connected")},fail:e=>{console.error("WebSocket connection failed",e)}}),e.wx$1.onSocketMessage((e=>{var t=e.data;console.log(t);var n=s.value[s.value.length-1];if(e.data&&""!==e.data.trim())if("[FINISH]"==e.data.trim())v.value=!1,p=!1;else{const e=h(t);if("nopic"==e)return;p?1==d.continues?s.value.push({type:"assistant",content:e||t,contentType:e?"image":"text",avatar:d.icon}):n.content+=t:(n.content=e||t,n.contentType=e?"image":"text",p=!0),m()}}))}catch(c){console.error("获取数据失败:",c)}finally{e.index.hideLoading()}}));const _=async()=>{const t=o.value.trim();if(t&&!v.value){v.value=!0,s.value.push({type:"user",content:t,avatar:""}),o.value="";try{const n={conversion_id:u.value,bot_id:r.value,user_id:a,input_text:t};e.wx$1.sendSocketMessage({data:JSON.stringify(n)}),s.value.push({type:"assistant",content:"正在输入...",avatar:d.icon}),m()}catch(n){console.error("获取数据失败:",n),v.value=!1}finally{e.index.hideLoading()}m()}},f=()=>{e.index.chooseImage({count:1,success:e=>{console.log("Selected image:",e.tempFilePaths[0])}})},y=()=>{const t={url:"https://real.aimh8.com/",title:d.name,bot_id:r.value,tts_id:d.tts_id,conversion_id:u.value,user_id:a,auto_call:1},n=Object.entries(t).map((([e,t])=>`${e}=${encodeURIComponent(t)}`)).join("&");e.index.navigateTo({url:`/pages/webview/webview?${n}`})};return e.onBeforeUnmount((()=>{g&&(g.close(),console.log("WebSocket connection closed"))})),(t,n)=>({a:e.o(y),b:e.f(s.value,((t,n,a)=>e.e({a:"assistant"===t.type&&t.avatar},"assistant"===t.type&&t.avatar?{b:t.avatar}:{},{c:"image"===t.contentType},"image"===t.contentType?{d:t.content,e:e.o((n=>{return a=t.content,void e.index.previewImage({urls:[a],current:a});var a}),n)}:{f:e.t(t.content)},{g:n,h:e.n(t.type)}))),c:c.value,d:i.value+"px",e:e.o(_),f:o.value,g:e.o((e=>o.value=e.detail.value)),h:e.o(_),i:v.value,j:v.value?1:"",k:e.o(f)})}},n=e._export_sfc(t,[["__scopeId","data-v-0d27deab"]]);wx.createPage(n);
