"use strict";const e=require("../../common/vendor.js"),t={__name:"edit-copy",setup(t){const o=e.ref(""),a=e.ref(""),n=e.ref(""),i=e.ref(""),l=e.ref(""),s=e.ref(""),d=e.ref(""),c=e.ref(""),r=e.ref(0),u=e.ref(""),v=e.ref(""),h=e.index.getStorageSync("phoneNum"),w=e.index.getStorageSync("user_id");r.value=e.index.getStorageSync("benefit");const g=e.ref(null),x=e.ref(!1),m=e.ref([]);var f,p=null,_=null,S=!0;const T=e.ref(!1),y=/编号：(\d+)[\s\S]*?账号名称：([^\n]+)[\s\S]*?标题：([^\n]+)[\s\S]*?点赞：(\d+)[\s\S]*?链接：(https:\/\/[^\s]+)/g;e.onMounted((async()=>{const t=getApp().globalData.currentOptions;console.log("接收到的参数:",t),a.value=t.title,o.value=t.muban_id,n.value=t.date,i.value=t.operator_id,l.value=t.operator,s.value=t.upload_id,d.value=t.upload,c.value=decodeURIComponent(t.thumbnail);try{const t=await e.index.request({url:"https://www.aimh8.com/agent/get_bots",method:"POST",header:{"Content-Type":"application/json"},data:{agent_id1:2,agent_id2:3,user_id:w,username:h}});console.log("返回数据:",t.data),t.data.code>0&&(p=t.data.list[0].bot_id,_=t.data.list[1].bot_id),b(),e.wx$1.onSocketMessage((t=>{t.data;if(t.data&&""!==t.data.trim())if("[FINISH]"==t.data.trim())T.value=!1;else{if(S){let e;for(;null!==(e=y.exec(t.data));){let t={id:e[1],accountName:e[2],title:e[3],likes:parseInt(e[4],10),link:e[5]};x.value=!0,m.value.some((e=>e.id===t.id))||m.value.push(t)}}else v.value+=t.data;e.index.hideLoading()}}))}catch(r){console.error("get_bots失败:",r)}finally{e.index.hideLoading()}}));const b=()=>new Promise(((t,o)=>{(f=e.wx$1.connectSocket({url:"wss://www.aimh8.com/wss/",success:()=>{console.log("WebSocket连接创建成功")},fail:e=>{console.error("WebSocket连接创建失败",e),o(e)}})).onOpen((()=>{console.log("WebSocket连接已打开"),t()})),f.onError((e=>{console.error("WebSocket连接错误",e),o(e)}))})),k=async()=>{try{return f&&1===f.readyState||(console.log("WebSocket未连接，尝试重新连接..."),await b(),await new Promise((e=>setTimeout(e,500)))),!0}catch(e){throw console.error("WebSocket重连失败:",e),e}},L=async()=>{S=!1;const t=v.value.trim();if(t){if(!T.value){T.value=!0,e.index.showLoading({title:"正在撰写..",mask:!0});try{const o={conversion_id:null,bot_id:_,user_id:w,input_text:t};await k(),await new Promise(((t,a)=>{e.wx$1.sendSocketMessage({data:JSON.stringify(o),success:t,fail:a})}))}catch(o){console.error("发送消息失败:",o),e.index.showToast({title:"发送失败，请重试",icon:"none"}),T.value=!1,e.index.hideLoading()}}}else e.index.showToast({title:"提示不能为空",icon:"none"})},P=async()=>{S=!0;const t=u.value.trim();if(t){if(!T.value)if(t.length>10)e.index.showToast({title:"关键词不能超过10个字",icon:"none"});else{T.value=!0,e.index.showLoading({title:"正在搜索..",mask:!0});try{const o={conversion_id:null,bot_id:p,user_id:w,input_text:t};await k(),await new Promise(((t,a)=>{e.wx$1.sendSocketMessage({data:JSON.stringify(o),success:t,fail:a})}))}catch(o){console.error("sendTileMessage失败:",o),T.value=!1,e.index.hideLoading()}}}else e.index.showToast({title:"关键词不能为空",icon:"none"})},O=async()=>{try{const t=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{generate_progress:!0,username:h,user_id:w}});if(t.data.code>=0){const o=t.data.value;if(e.index.showLoading({title:`正在合成中...${o}%`,mask:!0}),o>=100){e.index.showLoading({title:"获取合成视频...",mask:!0}),await new Promise((e=>setTimeout(e,6e3)));const t=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{getNewestVideoFile:!0,username:h,user_id:w}});t.data.code>=0?(e.index.hideLoading(),getApp().globalData.currentOptions={video_id:t.data.videoData[0],filetype:0},e.index.navigateTo({url:"/pages/video/detail2"})):e.index.showToast({title:"获取视频信息失败",icon:"none"})}else g.value=setTimeout(O,5e3)}else e.index.hideLoading(),e.index.showToast({title:"获取进度失败",icon:"none"})}catch(t){console.error("检查进度失败:",t),e.index.hideLoading(),e.index.showToast({title:"获取进度失败",icon:"none"})}},M=async()=>{if(!u.value)return void e.index.showToast({title:"请输入标题",icon:"none"});let t=u.value.trim();if(t.length<2)return void e.index.showToast({title:"标题不能低于2个字",icon:"none"});if(!v.value)return void e.index.showToast({title:"请输入正文",icon:"none"});let a=v.value.trim();if(a.length<6)return void e.index.showToast({title:"正文不能低于6个字",icon:"none"});if(a.length>1500)return void e.index.showToast({title:"正文长度不能超过1500个字",icon:"none"});const n=a.length,i=10*Math.ceil(n/150);r.value<i?e.index.showToast({title:"余额不足，请充值",icon:"none"}):e.index.showModal({title:"费用确认",content:`本次合成预计扣除${i}U，是否继续？`,success:async n=>{if(n.confirm)try{e.index.showLoading({title:"提交中...",mask:!0});const n=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{media_generate:!0,username:h,user_id:w,muban_id:o.value,text:a,text_title:t,cost:i}});console.log(n.data),n.data.code>=0?(r.value-=i,e.index.setStorageSync("benefit",r.value),O()):(e.index.showToast({title:"提交失败:"+n.data.msg,icon:"none"}),e.index.hideLoading())}catch(l){console.error("提交失败:",l),e.index.showToast({title:"提交失败，请重试",icon:"none"}),e.index.hideLoading()}}})};return e.onBeforeUnmount((()=>{g.value&&(clearTimeout(g.value),g.value=null),f&&(f.close(),console.log("WebSocket connection closed"))})),(t,o)=>e.e({a:c.value,b:e.t(a.value||"标题"),c:e.t(n.value||"时间"),d:e.t(d.value||"未知"),e:e.t(l.value||"未知"),f:u.value,g:e.o((e=>u.value=e.detail.value)),h:m.value.length>0},m.value.length>0?{i:e.t(x.value?"▲":"▼"),j:e.o((e=>x.value=!x.value))}:{},{k:e.o(P),l:T.value,m:T.value?1:"",n:e.f(m.value,((t,o,a)=>({a:e.t(t.title),b:e.t(t.likes),c:e.t(t.account),d:o,e:e.o((e=>(e=>{u.value=e.title,v.value=`请参考以下抖音视频链接改写文案:\n${e.link}`,x.value=!1})(t)),o)}))),o:x.value,p:v.value,q:e.o((e=>v.value=e.detail.value)),r:e.o(L),s:T.value,t:T.value?1:"",v:e.t(v.value.length),w:e.o(M),x:T.value,y:T.value?1:""})}},o=e._export_sfc(t,[["__scopeId","data-v-f510c2b6"]]);wx.createPage(o);
