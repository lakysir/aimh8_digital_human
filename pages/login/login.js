"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/config.js"),i=require("../../common/assets.js"),t={data:()=>({loginType:"password",phone:"",password:"",verificationCode:"",showPassword:!1,agreePolicy:!0,countdown:60,counting:!1,appid:"",mini_program_title:""}),onLoad(){try{const i=e.index.getAccountInfoSync();this.appid=i.miniProgram.appId,o.getMiniProgramInfo(this.appid).then((e=>{this.mini_program_title=e.title}))}catch(i){console.error("获取小程序信息失败:",i)}},computed:{isFormValid(){const e=this.phone.length>4;return"password"===this.loginType?e&&this.password.length>=6&&this.agreePolicy:e&&6===this.verificationCode.length&&this.agreePolicy},codeBtnDisabled(){return this.counting||!/^1[3-9]\d{9}$/.test(this.phone)},codeBtnText(){return this.counting?`重新发送(${this.countdown}s)`:"获取验证码"}},methods:{togglePasswordVisibility(){this.showPassword=!this.showPassword},toggleAgreement(){this.agreePolicy=!this.agreePolicy},sendCode(){this.codeBtnDisabled||(e.index.showLoading({title:"发送中..."}),setTimeout((()=>{e.index.hideLoading(),e.index.showToast({title:"验证码已发送",icon:"success"}),this.counting=!0,this.countdown=60;const o=setInterval((()=>{this.countdown-=1,this.countdown<=0&&(this.counting=!1,clearInterval(o))}),1e3)}),1e3))},login(){if(!this.isFormValid)return;e.index.showLoading({title:"登录中..."});const i={username:this.phone,password:this.password};e.index.request({url:o.SERVER_URL+"login",method:"POST",data:i,success:o=>{o.data.code>0?(e.index.setStorageSync("logged_in","true"),e.index.setStorageSync("user_info",JSON.stringify(o.data.userInfo)),e.index.reLaunch({url:"/pages/market/market"})):e.index.showToast({title:o.data.msg||"登录失败，请检查用户名和密码",icon:"none"})},fail:o=>{console.error("登录请求失败:",o),e.index.showToast({title:"登录请求失败，请检查网络",icon:"none"})},complete:()=>{e.index.hideLoading()}})},navigateToRegister(){e.index.navigateTo({url:"/pages/register/register"})},navigateToResetPassword(){e.index.navigateTo({url:"/pages/reset_password/reset_password"})},loginWithWechat(){e.index.showToast({title:"微信登录功能开发中",icon:"none"})},async handleGetPhoneNumber(i){if(i.detail.code){e.index.showLoading({title:"正在登录",mask:!0});const{code:t}=await e.index.login(),n={appid:this.appid,code:t,phoneCode:i.detail.code};e.index.request({url:o.SERVER_URL+"wechat_login",method:"POST",data:n,success:o=>{o.data.code>0?(console.log(o.data),e.index.setStorageSync("logged_in","true"),e.index.setStorageSync("user_info",JSON.stringify(o.data.userInfo)),e.index.reLaunch({url:"/pages/market/market"})):e.index.showToast({title:o.data.msg||"登录失败，请检查用户名和密码",icon:"none"})},fail:o=>{console.error("登录请求失败:",o),e.index.showToast({title:"登录请求失败，请检查网络",icon:"none"})},complete:()=>{e.index.hideLoading()}})}},viewUserAgreement(){e.index.navigateTo({url:"/pages/agreement/user_agreement"})},viewPrivacyPolicy(){e.index.navigateTo({url:"/pages/agreement/privacy_policy"})}}};const n=e._export_sfc(t,[["render",function(o,t,n,s,a,r){return e.e({a:i._imports_0,b:e.t(a.mini_program_title),c:a.phone,d:e.o((e=>a.phone=e.detail.value)),e:"password"===a.loginType},"password"===a.loginType?{f:a.showPassword?"text":"password",g:a.password,h:e.o((e=>a.password=e.detail.value)),i:e.t(a.showPassword?"👁️":"👁️‍🗨️"),j:e.o(((...e)=>r.togglePasswordVisibility&&r.togglePasswordVisibility(...e)))}:{},{k:"code"===a.loginType},"code"===a.loginType?{l:a.verificationCode,m:e.o((e=>a.verificationCode=e.detail.value)),n:e.t(r.codeBtnText),o:r.codeBtnDisabled,p:e.o(((...e)=>r.sendCode&&r.sendCode(...e)))}:{},{q:!r.isFormValid,r:e.o(((...e)=>r.login&&r.login(...e))),s:e.o(((...e)=>r.handleGetPhoneNumber&&r.handleGetPhoneNumber(...e))),t:a.agreePolicy,v:e.o(((...e)=>r.toggleAgreement&&r.toggleAgreement(...e))),w:e.o(((...e)=>r.viewUserAgreement&&r.viewUserAgreement(...e))),x:e.o(((...e)=>r.viewPrivacyPolicy&&r.viewPrivacyPolicy(...e)))})}]]);wx.createPage(n);
