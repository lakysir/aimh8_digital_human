"use strict";const t=require("../../common/vendor.js"),e=require("../../utils/config.js"),a=require("../../common/assets.js"),i={data:()=>({currentTab:0,tabs:[{name:"训练完成"},{name:"训练中"}],loading:!1,page:1,pageSize:10,totalPages:1,userId:"",completedAvatars:[],trainingAvatars:[],showSettingsModal:!1,currentAvatar:null,avatarSettings:{id:null,title:"",description:"",price_min:30,isdefault:0,strict_review:!1}}),onLoad(){this.userId=e.getUserID(),this.loadDigitalHumans()},methods:{switchTab(t){this.currentTab=t,this.loadDigitalHumans()},loadDigitalHumans(){this.loading=!0;const a={uni_token:e.getUserUniToken(),page:this.page,page_size:this.pageSize};t.index.request({url:e.SERVER_URL+"get_user_avatars",method:"POST",data:a,header:{"Content-Type":"application/json"},success:e=>{this.loading=!1;const a=e.data;a.code>0?(this.totalPages=a.total_pages||1,0===this.currentTab?(console.log(a),this.completedAvatars=a.dataInfos||[]):this.loadTrainingDigitalHumans()):t.index.showToast({title:a.msg||"获取数字人列表失败，请重试",icon:"none"})},fail:e=>{this.loading=!1,t.index.showToast({title:"获取数字人列表失败，请检查网络连接",icon:"none"}),console.error("获取数字人列表失败:",e)}})},loadTrainingDigitalHumans(){this.loading=!0;const a=e.getUserUniToken();t.index.request({url:e.SERVER_URL+"get_training_avatars",method:"POST",data:{uni_token:a,page:this.page,page_size:this.pageSize},header:{"Content-Type":"application/json"},success:e=>{this.loading=!1;const a=e.data;console.log(a),a.code>0?(a.avatars&&(this.trainingAvatars=a.avatars),this.totalPages=a.total_pages||1,0===this.trainingAvatars.length&&console.log("没有训练中的数字人")):(t.index.showToast({title:a.msg||"获取训练中的数字人失败",icon:"none"}),this.trainingAvatars=[])},fail:e=>{this.loading=!1,t.index.showToast({title:"获取训练中的数字人失败，请检查网络连接",icon:"none"}),console.error("获取训练中的数字人失败:",e),this.trainingAvatars=[]}})},navigateToCreate(){t.index.navigateTo({url:"/pages/avatar_create/avatar_create"})},getVideoUrl(t,e){let a;return a=t.endsWith("/")?t+e:t+"/"+e,a},playPreviewVideo(a){if(!e.hasVideoPermission())return;let i=a.main_path;const n=this.getVideoUrl(i,"example.mp4");t.index.navigateTo({url:`/pages/preview/preview?video=${encodeURIComponent(n)}&mainVideo=${encodeURIComponent(this.getVideoUrl(i,"main.mp4"))}&title=${encodeURIComponent(a.name||"数字人预览")}`})},playTrainingVideo(t,e){console.log("播放训练视频:",t,e)},useDigitalHuman(e){console.log("使用数字人:",e),t.index.navigateTo({url:`/pages/script_editor/script_editor?avatar_id=${e}`})},editDigitalHuman(e){console.log("编辑数字人:",e),t.index.navigateTo({url:`/pages/avatar_edit/avatar_edit?id=${e}`})},openSettingsModal(e){const a=this.completedAvatars.find((t=>t.id===e));a?(this.currentAvatar=a,this.avatarSettings={id:a.id,title:a.name||"我的数字人",description:a.description||"",price_min:a.price_min||30,isdefault:a.isdefault||0,strict_review:a.strict_review||!1},this.showSettingsModal=!0):t.index.showToast({title:"数字人不存在",icon:"none"})},closeSettingsModal(){this.showSettingsModal=!1,this.currentAvatar=null},onPriceChange(t){this.avatarSettings.price_min=t.detail.value},onMarketStatusChange(t){this.avatarSettings.isdefault=t.detail.value?2:0},onStrictReviewChange(t){this.avatarSettings.strict_review=t.detail.value},saveSettings(){if(!this.avatarSettings.title.trim())return void t.index.showToast({title:"请输入数字人名称",icon:"none"});t.index.showLoading({title:"保存中..."});const a={uni_token:e.getUserUniToken(),avatar_id:this.avatarSettings.id,title:this.avatarSettings.title,description:this.avatarSettings.description,price_min:this.avatarSettings.price_min,in_market:this.avatarSettings.isdefault,strict_review:this.avatarSettings.strict_review?1:0};console.log(a),t.index.request({url:e.SERVER_URL+"update_avatar_settings",method:"POST",data:a,header:{"Content-Type":"application/json"},success:e=>{t.index.hideLoading(),console.log(e);const a=e.data;a.code>0?(t.index.showToast({title:"保存成功",icon:"success"}),this.closeSettingsModal(),this.loadDigitalHumans()):t.index.showToast({title:a.msg||"保存失败",icon:"none"})},fail:e=>{t.index.hideLoading(),t.index.showToast({title:"保存失败，请检查网络连接",icon:"none"}),console.error("保存数字人设置失败:",e)}})},deleteTrainingDigitalHuman(a){t.index.showModal({title:"确认删除",content:"确定要删除这个训练中的数字人吗？",success:i=>{if(i.confirm){const i=e.getUserUniToken();t.index.request({url:e.SERVER_URL+"delete_training_avatar",method:"POST",data:{uni_token:i,avatar_id:a},header:{"Content-Type":"application/json"},success:e=>{const a=e.data;a.code>0?(t.index.showToast({title:"删除成功",icon:"success"}),this.loadTrainingDigitalHumans()):t.index.showToast({title:a.msg||"删除失败",icon:"none"})},fail:e=>{t.index.showToast({title:"删除失败，请检查网络连接",icon:"none"}),console.error("删除训练中的数字人失败:",e)}})}}})},formatDate(t){if(!t)return"未知时间";const e=new Date(t);return`${e.getFullYear()}-${this.padZero(e.getMonth()+1)}-${this.padZero(e.getDate())}`},padZero:t=>t<10?`0${t}`:t,getStatusText:t=>1===t.isdefault?"官方数字人":2===t.isdefault?"已上架":"未上架",getTrainingStatusText:t=>0===t.train_userid?1===t.check_status?"已拒绝":"待训练":"训练中",getTrainingStatusClass:t=>0===t.train_userid?1===t.check_status?"status-rejected":"status-pending":"status-training",getTrainingStatusIcon:t=>0===t.train_userid?1===t.check_status?"icon-close-circle":"icon-clock":"icon-loading",canDelete:t=>0===t.train_userid}};const n=t._export_sfc(i,[["render",function(e,i,n,s,o,r){return t.e({a:t.f(o.tabs,((e,a,i)=>({a:t.t(e.name),b:a,c:o.currentTab===a?1:"",d:t.o((t=>r.switchTab(a)),a)}))),b:t.o(((...t)=>r.navigateToCreate&&r.navigateToCreate(...t))),c:0===o.currentTab},0===o.currentTab?t.e({d:o.loading},(o.loading,{}),{e:!o.loading&&o.completedAvatars.length>0},!o.loading&&o.completedAvatars.length>0?{f:t.f(o.completedAvatars,((e,a,i)=>t.e({a:e.image||"/static/images/placeholder.jpg",b:t.t(r.getStatusText(e)),c:2===e.isdefault?1:"",d:1===e.isdefault?1:"",e:t.o((t=>r.playPreviewVideo(e)),a),f:t.t(e.name||"我的数字人"),g:t.t(r.formatDate(e.publishDate)),h:1===e.isdefault||2===e.isdefault},1===e.isdefault||2===e.isdefault?{i:t.t(e.price_min||10)}:{},{j:t.o((t=>r.useDigitalHuman(e.id)),a),k:1!==e.isdefault},1!==e.isdefault?t.e({l:e.auth_user_id==o.userId},e.auth_user_id==o.userId?{m:t.o((t=>r.openSettingsModal(e.id)),a)}:{}):{},{n:a})))}:{},{g:!o.loading&&0===o.completedAvatars.length},o.loading||0!==o.completedAvatars.length?{}:{h:a._imports_0$2}):{},{i:1===o.currentTab},1===o.currentTab?t.e({j:o.loading},(o.loading,{}),{k:!o.loading&&o.trainingAvatars.length>0},!o.loading&&o.trainingAvatars.length>0?{l:t.f(o.trainingAvatars,((e,a,i)=>t.e({a:t.t(r.getTrainingStatusText(e)),b:t.n(r.getTrainingStatusClass(e)),c:t.t(e.title||"未命名数字人"),d:t.t(e.description||""),e:t.t(r.formatDate(e.upload_time)),f:r.canDelete(e)},r.canDelete(e)?{g:t.o((t=>r.deleteTrainingDigitalHuman(e.id)),a)}:{},{h:a})))}:{},{m:!o.loading&&0===o.trainingAvatars.length},o.loading||0!==o.trainingAvatars.length?{}:{n:a._imports_1}):{},{o:o.showSettingsModal},o.showSettingsModal?{p:t.t(o.currentAvatar?o.currentAvatar.name:"数字人"),q:t.o(((...t)=>r.closeSettingsModal&&r.closeSettingsModal(...t))),r:o.avatarSettings.title,s:t.o((t=>o.avatarSettings.title=t.detail.value)),t:o.avatarSettings.description,v:t.o((t=>o.avatarSettings.description=t.detail.value)),w:t.t(o.avatarSettings.price_min),x:o.avatarSettings.price_min,y:t.o(((...t)=>r.onPriceChange&&r.onPriceChange(...t))),z:2===o.avatarSettings.isdefault,A:t.o(((...t)=>r.onMarketStatusChange&&r.onMarketStatusChange(...t))),B:o.avatarSettings.strict_review,C:t.o(((...t)=>r.onStrictReviewChange&&r.onStrictReviewChange(...t))),D:t.o(((...t)=>r.closeSettingsModal&&r.closeSettingsModal(...t))),E:t.o(((...t)=>r.saveSettings&&r.saveSettings(...t)))}:{})}]]);wx.createPage(n);
