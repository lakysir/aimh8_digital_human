"use strict";const e=require("../../common/vendor.js"),n={__name:"index",setup(n){const t=e.index.getStorageSync("phoneNum"),i=e.index.getStorageSync("user_id"),o=e.index.getStorageSync("user_type"),a=e.wx$1.getAccountInfoSync().miniProgram.appId,s=e.ref(!1),d=e.ref(0),c=e.ref(0),l=e.ref("");e.onMounted((async()=>{const n=getCurrentPages(),t=n[n.length-1].$page.fullPath;if(console.log(t),t.includes("scene=")){const e=t.split("scene=")[1];console.log(e);const n=decodeURIComponent(decodeURIComponent(e));console.log(n);const o=n.split("invite_id=")[1];d.value=o,s.value=!0,console.log(d.value),i>0&&await u("","")}else if(t.includes("invite_id=")){const e=t.split("invite_id=")[1];d.value=e,c.value=1,s.value=!0,i>0&&await u("","")}else if(t.includes("invite_id_notowner=")){const e=t.split("invite_id_notowner=")[1];d.value=e,c.value=0,s.value=!0,i>0&&await u("","")}else if(t.includes("request_bind_operate=")){const n=t.split("request_bind_operate=")[1];i&&i>0&&(3===o?e.index.showModal({title:"注意",content:"您是否愿意成为他的代运营？",showCancel:!0,confirmText:"确认",success:async e=>{e.confirm&&await r(n,i)}}):e.index.showModal({title:"注意",content:"您不是运营商！",showCancel:!1,confirmText:"取消",success:n=>{n.confirm&&e.index.redirectTo({url:"/pages/main/index"})}}))}else e.index.showToast({title:"需要邀请才能注册",icon:"none"})}));const r=async(n,i)=>{e.index.showLoading({title:"正在授权..."});try{const o=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{bindInviteCode:!0,username:t,user_id:i,saler_id:n}});console.log(o.data),o.data.code>=0?e.index.showModal({title:"注意",content:"授权成功",showCancel:!1,confirmText:"确认",success:n=>{n.confirm&&e.index.reLaunch({url:"/pages/main/index"})}}):e.index.showToast({title:o.data.msg||"绑定失败",icon:"none"})}catch(o){console.error("绑定失败:",o),e.index.showToast({title:"绑定失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},u=async(n,i)=>{try{const o=await e.index.request({url:"https://www.aimh8.com/wechat_index.php",method:"POST",data:{appid:a,registrationData:!0,code:n,phone_code:i,nickname:l.value.trim(),invite_user_id:d.value,username:t,inviteOwner:c.value}});console.log(o.data),o.data.code>=0?(e.index.setStorageSync("phoneNum",o.data.phoneNum),e.index.setStorageSync("user_id",o.data.user_id),e.index.setStorageSync("nicename",o.data.nicename),e.index.setStorageSync("benefit",o.data.benefit),e.index.setStorageSync("user_type",o.data.user_type),e.index.setStorageSync("upid",o.data.upid),e.index.setStorageSync("partner_id",o.data.partner_id),e.index.redirectTo({url:"/pages/main/index"})):e.index.showToast({title:"登录失败:"+o.data.msg,icon:"none"})}catch(o){console.error("登录失败:",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}finally{e.index.hideLoading()}},x=async n=>{if(s.value)if(""!=l.value.trim()){if(n.detail.code){e.index.showLoading({title:"正在注册...",mask:!0});const{code:t}=await e.index.login();await u(t,n.detail.code)}}else e.index.showToast({title:"昵称不能为空",icon:"none"});else e.index.showToast({title:"邀请人ID为0，不能注册",icon:"none"})};return(n,t)=>({a:l.value,b:e.o((e=>l.value=e.detail.value)),c:e.o(x)})}};wx.createPage(n);
