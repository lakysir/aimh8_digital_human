"use strict";const o=require("../../common/vendor.js"),i=require("../../utils/config.js"),e={data:()=>({title:"数字人预览",primaryVideoUrl:"",mainVideoUrl:"",isUsingMainVideo:!1,isLoading:!0,hasError:!1,errorMessage:"视频加载失败",videoContext:null,showOriVideo:!1,has_permission:!1,isFromShare:!1,share:{title:"数字人预览",path:"/pages/preview/preview",imageUrl:""},showDownloadBtn:!1,isDownloading:!1,downloadProgress:0,currentDownloadTask:null}),computed:{currentVideoUrl(){return this.isUsingMainVideo?this.mainVideoUrl:this.primaryVideoUrl},hasMainVideo(){return!!this.mainVideoUrl&&this.mainVideoUrl!==this.primaryVideoUrl}},onLoad(e){const s={};e.fromShare?(this.isFromShare=!0,this.showOriVideo=!0,this.has_permission=!0):(this.has_permission=i.hasVideoPermission(),this.has_permission?this.showOriVideo=!0:this.showOriVideo=!1),"true"!==e.download&&"1"!==e.download||(this.showDownloadBtn=!0),e.mainVideo&&(this.mainVideoUrl=decodeURIComponent(e.mainVideo)),e.title&&(this.title=decodeURIComponent(e.title)),e.video&&(this.primaryVideoUrl=decodeURIComponent(e.video),this.checkVideoExists(this.primaryVideoUrl).then((o=>{!o&&this.hasMainVideo&&(console.log("主视频不存在，自动切换到流畅版本"),this.switchVideo())}))),this.videoContext=o.index.createVideoContext("myVideo",this),this.primaryVideoUrl&&(s.video=this.primaryVideoUrl),this.title&&(s.title=this.title),this.mainVideoUrl&&(s.mainVideo=this.mainVideoUrl),s.fromShare=!0,this.showDownloadBtn&&(s.download="true");let t=`分享: ${this.title}`,n=`/pages/preview/preview?${Object.keys(s).map((o=>`${o}=${encodeURIComponent(s[o])}`)).join("&")}`;this.share={title:t,path:n,imageUrl:""},console.log(this.share)},onShareAppMessage(){return this.share},methods:{checkVideoExists:i=>new Promise((e=>{o.index.request({url:i,method:"HEAD",success:o=>{e(o.statusCode>=200&&o.statusCode<300)},fail:()=>{e(!1)}})})),handleVideoPlay(){this.isLoading=!1,this.hasError=!1},handleVideoError(o){console.error("视频播放错误:",o),this.isLoading=!1,this.hasError=!0,!this.isUsingMainVideo&&this.hasMainVideo?(this.errorMessage="高清视频加载失败，正在尝试播放流畅版本...",setTimeout((()=>{this.switchVideo()}),1500)):this.errorMessage="视频无法播放，请稍后再试"},handleVideoEnded(){console.log("视频播放结束")},switchVideo(){this.isLoading=!0,this.hasError=!1,this.isUsingMainVideo=!this.isUsingMainVideo,setTimeout((()=>{this.videoContext.play()}),300)},goBack(){o.index.navigateBack()},downloadVideo(){this.currentVideoUrl?o.index.authorize({scope:"scope.writePhotosAlbum",success:()=>{this.isDownloading=!0,this.downloadProgress=0,o.index.showLoading({title:"下载中..."});const i=o.index.downloadFile({url:this.currentVideoUrl,success:i=>{if(200===i.statusCode){const e=i.tempFilePath;o.index.saveVideoToPhotosAlbum({filePath:e,success:()=>{o.index.hideLoading(),o.index.showToast({title:"保存成功",icon:"success"})},fail:i=>{o.index.hideLoading(),o.index.showToast({title:"保存失败",icon:"error"}),console.error("保存视频失败：",i)},complete:()=>{this.isDownloading=!1}})}},fail:i=>{o.index.hideLoading(),o.index.showToast({title:"下载失败",icon:"error"}),console.error("下载视频失败：",i),this.isDownloading=!1}});i.onProgressUpdate((o=>{this.downloadProgress=o.progress})),this.currentDownloadTask=i},fail:()=>{o.index.showModal({title:"提示",content:"需要您授权保存到相册的权限",confirmText:"去设置",success:i=>{i.confirm&&o.index.openSetting()}})}}):o.index.showToast({title:"视频地址无效",icon:"none"})},cancelDownload(){this.currentDownloadTask&&(this.currentDownloadTask.abort(),this.currentDownloadTask=null),this.isDownloading=!1,o.index.showToast({title:"已取消下载",icon:"none"})}}};if(!Array){o.resolveComponent("txv-video")()}const s=o._export_sfc(e,[["render",function(i,e,s,t,n,r){return o.e({a:n.showOriVideo},n.showOriVideo?{b:r.currentVideoUrl,c:o.o(((...o)=>r.handleVideoError&&r.handleVideoError(...o))),d:o.o(((...o)=>r.handleVideoPlay&&r.handleVideoPlay(...o))),e:o.o(((...o)=>r.handleVideoEnded&&r.handleVideoEnded(...o)))}:{f:i.videoUrl,g:o.o(r.handleVideoError)},{h:o.t(n.title),i:o.o(((...o)=>r.goBack&&r.goBack(...o))),j:n.showDownloadBtn},n.showDownloadBtn?{k:o.o(((...o)=>r.downloadVideo&&r.downloadVideo(...o)))}:{},{l:n.isLoading},(n.isLoading,{}),{m:n.hasError},n.hasError?{n:o.t(n.errorMessage)}:{},{o:n.isDownloading},n.isDownloading?{p:n.downloadProgress+"%",q:o.t(n.downloadProgress),r:o.o(((...o)=>r.cancelDownload&&r.cancelDownload(...o)))}:{})}]]);e.__runtimeHooks=2,wx.createPage(s);
